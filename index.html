<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            touch-action: pan-y;
            overflow-x: hidden;
        }
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: fadeOut 1s ease 3s forwards;
        }
        @keyframes fadeOut { to { opacity: 0; pointer-events: none; } }
        .anime-character { text-align: center; animation: bounceIn 0.8s ease; }
        @keyframes bounceIn {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .character-img {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 120px;
            margin: 0 auto 20px;
        }
        .speech-bubble {
            background: white;
            padding: 20px 30px;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: popIn 0.5s ease 0.5s backwards;
        }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .speech-bubble::before {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            border: 10px solid transparent;
            border-top-color: white;
        }
        .speech-bubble h2 { color: #667eea; margin-bottom: 10px; }
        .speech-bubble p { color: #666; }
        #main-content {
            opacity: 0;
            animation: fadeIn 1s ease 4s forwards;
            padding: 20px;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-radius: 10px;
        }
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .logo { font-size: 24px; font-weight: bold; color: #667eea; }
        .nav-links { display: flex; gap: 20px; flex-wrap: wrap; }
        .nav-links a {
            color: #333;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .nav-links a:hover { background: #667eea; color: white; }
        .user-info { display: flex; gap: 10px; align-items: center; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-secondary:hover { background: #667eea; color: white; }
        .btn-danger { background: #ff6b6b; color: white; padding: 5px 10px; font-size: 12px; }
        .btn-danger:hover { background: #ff5252; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .section { display: none; animation: slideIn 0.5s ease; }
        .section.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        h1 { color: #667eea; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; color: #333; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .category-selector { display: flex; gap: 10px; align-items: flex-end; }
        .category-selector > div { flex: 1; }
        .new-category-input { display: none; margin-top: 10px; }
        .new-category-input.active { display: block; }
        .category-filter { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .category-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .category-btn:hover, .category-btn.active { background: #667eea; color: white; }
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .content-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s;
            background: white;
            position: relative;
        }
        .content-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .content-card img, .content-card video { width: 100%; height: 200px; object-fit: cover; }
        .content-card-body { padding: 15px; }
        .content-card-body h3 { color: #333; margin-bottom: 10px; }
        .content-card-body p { color: #666; font-size: 14px; }
        .category-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            z-index: 5;
        }
        .delete-post-btn { position: absolute; top: 10px; right: 10px; z-index: 10; }
        .comments-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .comment { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px; position: relative; }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .comment-author { font-weight: bold; color: #667eea; font-size: 13px; }
        .comment-text { color: #333; font-size: 13px; }
        .comment-form { margin-top: 10px; display: flex; gap: 5px; }
        .comment-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            animation: modalSlideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes modalSlideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #667eea; }
        .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .close-modal:hover { color: #333; }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
            flex-shrink: 0;
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .hidden { display: none; }
        .admin-badge { background: #ff6b6b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
        .share-buttons { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .btn-share {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-share:hover { transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .btn-whatsapp { background: #25D366; color: white; }
        .btn-facebook { background: #1877F2; color: white; }
        .btn-twitter { background: #1DA1F2; color: white; }
        .btn-copy { background: #6c757d; color: white; }
        .btn-copy.copied { background: #28a745; }
        .stats-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
        .stat-item { text-align: center; }
        .stat-number { font-size: 28px; font-weight: bold; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        .forgot-password-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
        }
        .forgot-password-link:hover { text-decoration: underline; }
        .chat-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-button:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
        .chat-button .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .chat-list-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 998;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }
        .chat-list-window.active { display: flex; }
        .chat-window {
            position: fixed;
            bottom: 100px;
            right: 400px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 997;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }
        .chat-window.active { display: flex; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-header h3 { margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-conversations-list { flex: 1; overflow-y: auto; background: #f8f9fa; }
        .conversation-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }
        .conversation-item:hover { background: #e9ecef; }
        .conversation-item.active { background: #e7e9fc; }
        .conversation-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
            overflow: hidden;
        }
        .conversation-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .conversation-info { flex: 1; min-width: 0; }
        .conversation-name { font-weight: bold; color: #333; margin-bottom: 3px; }
        .conversation-preview {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .conversation-unread {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; background: #f8f9fa; }
        .chat-message { margin-bottom: 15px; animation: messageSlideIn 0.3s ease; }
        @keyframes messageSlideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .chat-message.own { text-align: right; }
        .chat-message .message-author { font-size: 12px; color: #667eea; font-weight: bold; margin-bottom: 3px; }
        .chat-message.own .message-author { color: #764ba2; }
        .chat-message .message-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }
        .chat-message.own .message-bubble { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .chat-message .message-time { font-size: 10px; color: #999; margin-top: 3px; }
        .chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
        }
        .chat-input:focus { border-color: #667eea; }
        .chat-send {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-send:hover { transform: scale(1.1); }
        .user-profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none !important;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
            transform: scale(0);
        }
        .user-profile-modal.active { 
            display: flex !important;
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
        }
        .user-profile-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease;
        }
        .user-profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px 20px;
            text-align: center;
            color: white;
            position: relative;
        }
        .user-profile-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .user-profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #667eea;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            overflow: hidden;
            border: 3px solid #667eea;
        }
        .user-profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-profile-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
        .user-profile-username { font-size: 14px; opacity: 0.9; }
        .user-profile-body { padding: 25px; }
        .user-profile-info { margin-bottom: 20px; }
        .user-profile-info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            color: #666;
            font-size: 14px;
        }
        .user-profile-actions { display: flex; gap: 10px; flex-direction: column; }
        .profile-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .profile-btn-message { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .profile-btn-message:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .profile-btn-block { background: #ff6b6b; color: white; }
        .profile-btn-block:hover { background: #ff5252; }
        .profile-btn-unblock { background: #28a745; color: white; }
        .profile-btn-unblock:hover { background: #218838; }
        .username-link { color: #667eea; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .username-link:hover { color: #764ba2; text-decoration: underline; }
        .no-conversations { padding: 40px 20px; text-align: center; color: #999; }
        .no-conversations p { margin-bottom: 10px; }
        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            padding: 20px;
            text-align: center;
        }
        .empty-chat-icon { font-size: 64px; margin-bottom: 15px; opacity: 0.5; }
        .profile-picture-area {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .profile-picture-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            border: 3px solid #667eea;
            overflow: hidden;
        }
        .profile-picture-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        @media (max-width: 768px) {
            .character-img { width: 200px; height: 200px; font-size: 100px; }
            .nav-links { width: 100%; justify-content: center; }
            .container { padding: 15px; }
            .content-grid { grid-template-columns: 1fr; gap: 15px; }
            .modal-content { width: 95%; padding: 20px; }
            .form-group input, .form-group textarea, .form-group select { font-size: 16px; }
            .comment-input { font-size: 16px; }
            .category-selector { flex-direction: column; }
            .chat-list-window { bottom: 90px; right: 10px; left: 10px; width: auto; height: 450px; }
            .chat-window { bottom: 90px; right: 10px; left: 10px; width: auto; height: 450px; }
            .chat-button { bottom: 20px; right: 20px; }
        }
    </style>
</head>
<body>
    <div id="welcome-screen">
        <div class="anime-character">
            <div class="character-img">üå∏</div>
            <div class="speech-bubble">
                <h2>¬°Hello World! üëã</h2>
                <p>Bienvenido al portal. ¬°Disfruta tu estancia!</p>
            </div>
        </div>
    </div>

    <div id="main-content">
        <header>
            <nav>
                <div class="logo">üå∏ Portal</div>
                <div class="nav-links">
                    <a href="#" onclick="event.preventDefault(); showSection('home');">Inicio</a>
                    <a href="#" onclick="event.preventDefault(); showSection('gallery');">Galer√≠a</a>
                </div>
                <div class="user-info">
                    <div id="guest-buttons">
                        <button class="btn btn-primary" onclick="showLogin()">Iniciar Sesi√≥n</button>
                        <button class="btn btn-secondary" onclick="showRegister()">Registrarse</button>
                    </div>
                    <div id="user-logged" class="hidden">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <span id="userName"></span>
                        <span id="adminBadge" class="admin-badge hidden">ADMIN</span>
                        <button class="btn btn-secondary" onclick="showMyProfile()">Mi Perfil</button>
                        <button class="btn btn-secondary" onclick="logout()">Salir</button>
                    </div>
                </div>
            </nav>
        </header>

        <div class="container">
            <section id="home" class="section active">
                <h1>¬°Bienvenido al Portal! üéå</h1>
                <div class="stats-banner">
                    <div class="stat-item">
                        <div class="stat-number" id="totalPosts">0</div>
                        <div class="stat-label">Publicaciones</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalCategories">0</div>
                        <div class="stat-label">Categor√≠as</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalComments">0</div>
                        <div class="stat-label">Comentarios</div>
                    </div>
                </div>
                <p>Este es un espacio para disfrutar y compartir contenido.</p>
                <p><strong>Reg√≠strate</strong> para poder dejar comentarios y chatear con otros usuarios.</p>
            </section>

            <section id="upload" class="section">
                <h1>Panel de Administrador üì§</h1>
                <form id="uploadForm">
                    <div class="form-group">
                        <label>Tipo:</label>
                        <select id="contentType" onchange="updateUploadForm()">
                            <option value="image">Imagen</option>
                            <option value="video">Video</option>
                            <option value="info">Info</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>T√≠tulo:</label>
                        <input type="text" id="contentTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n:</label>
                        <textarea id="contentDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a:</label>
                        <div class="category-selector">
                            <div>
                                <select id="categorySelect" onchange="toggleNewCategory()">
                                    <option value="">Seleccionar...</option>
                                    <option value="nueva">‚ûï Nueva categor√≠a</option>
                                </select>
                            </div>
                        </div>
                        <div class="new-category-input" id="newCategoryInput">
                            <input type="text" id="newCategoryName" placeholder="Nombre de la categor√≠a">
                        </div>
                    </div>
                    <div id="fileInputArea" class="form-group">
                        <label>Archivo:</label>
                        <input type="file" id="contentFile" accept="image/*,video/*">
                    </div>
                    <button type="submit" class="btn btn-primary">Publicar</button>
                </form>
            </section>

            <section id="gallery" class="section">
                <h1>Galer√≠a üñºÔ∏è</h1>
                <div class="category-filter" id="categoryFilter">
                    <button class="category-btn active" onclick="filterByCategory('all')">üìÇ Todas</button>
                </div>
                <div class="content-grid" id="contentGrid"></div>
            </section>
        </div>
    </div>

    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Iniciar Sesi√≥n</h2>
                <button class="close-modal" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Usuario:</label>
                    <input type="text" id="loginUser" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button>
                <a class="forgot-password-link" onclick="showForgotPassword()">¬øOlvidaste tu contrase√±a?</a>
            </form>
        </div>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrarse</h2>
                <button class="close-modal" onclick="closeModal('registerModal')">&times;</button>
            </div>
            <form id="registerForm">
                <div class="form-group">
                    <label>Nombre:</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label>Usuario:</label>
                    <input type="text" id="registerUser" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label>Pregunta de seguridad:</label>
                    <select id="registerSecurityQuestion" required>
                        <option value="">Selecciona...</option>
                        <option value="¬øCu√°l es el nombre de tu primera mascota?">¬øMascota?</option>
                        <option value="¬øEn qu√© ciudad naciste?">¬øCiudad natal?</option>
                        <option value="¬øCu√°l es tu color favorito?">¬øColor favorito?</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Respuesta:</label>
                    <input type="text" id="registerSecurityAnswer" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a:</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Crear Cuenta</button>
            </form>
        </div>
    </div>

    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Recuperar Contrase√±a</h2>
                <button class="close-modal" onclick="closeModal('forgotPasswordModal')">&times;</button>
            </div>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label>Usuario:</label>
                    <input type="text" id="forgotUser" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Verificar</button>
            </form>
        </div>
    </div>

    <div class="modal" id="securityQuestionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Pregunta de Seguridad</h2>
                <button class="close-modal" onclick="closeModal('securityQuestionModal')">&times;</button>
            </div>
            <form id="securityQuestionForm">
                <div class="form-group">
                    <label id="securityQuestionLabel"></label>
                    <input type="text" id="securityAnswer" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Verificar</button>
            </form>
        </div>
    </div>

    <div class="modal" id="resetPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nueva Contrase√±a</h2>
                <button class="close-modal" onclick="closeModal('resetPasswordModal')">&times;</button>
            </div>
            <form id="resetPasswordForm">
                <div class="form-group">
                    <label>Nueva contrase√±a:</label>
                    <input type="password" id="newPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Confirmar:</label>
                    <input type="password" id="confirmPassword" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Cambiar</button>
            </form>
        </div>
    </div>

    <div class="modal" id="myProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Mi Perfil</h2>
                <button class="close-modal" onclick="closeMyProfile()">&times;</button>
            </div>
            <form id="myProfileForm">
                <div class="profile-picture-area">
                    <div class="profile-picture-preview" id="myProfilePicturePreview">üë§</div>
                    <label style="display: block; margin-bottom: 10px; color: #333; font-weight: bold;">
                        Foto de Perfil:
                    </label>
                    <input type="file" id="myProfilePicture" accept="image/*" onchange="previewMyProfilePicture()">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <button class="chat-button" onclick="toggleChatList()">
        üí¨
        <span class="notification-badge hidden" id="chatNotification">0</span>
    </button>

    <div class="chat-list-window" id="chatListWindow">
        <div class="chat-header">
            <h3>üí¨ Mensajes</h3>
            <button class="chat-close" onclick="toggleChatList()">√ó</button>
        </div>
        <div class="chat-conversations-list" id="conversationsList"></div>
    </div>

    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <h3>
                <button onclick="backToConversations()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚Üê</button>
                <span id="chatRecipientName"></span>
            </h3>
            <button class="chat-close" onclick="closePrivateChat()">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Escribe..." onkeypress="handleChatKeyPress(event)">
            <button class="chat-send" onclick="sendPrivateMessage()">üì§</button>
        </div>
    </div>

    <div class="modal" id="moderatorsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Gestionar Moderadores</h2>
                <button class="close-modal" onclick="closeModeratorsPanel()">&times;</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Moderadores Actuales üõ°Ô∏è</h3>
                    <div id="moderatorsList"></div>
                </div>
                <hr style="border: 1px solid #ddd;">
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">Promover a Moderador ‚¨ÜÔ∏è</h3>
                    <div id="usersToPromoteList"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const ADMIN_USER = 'Inder';
        const ADMIN_PASSWORD = 'admin123';
        const LOCAL_STORAGE_KEY = 'portalLocalData';
        const SESSION_KEY = 'portalUserSession';

        let currentUser = null;
        let isAdmin = false;
        let isModerator = false;
        let currentCategory = 'all';
        let database = null;
        let firebaseInitialized = false;
        let currentChatRecipient = null;
        let selectedUserProfile = null;
        let conversations = {};
        let blockedUsers = [];
        let unreadMessages = 0;
        let isListOpen = false;
        let recoveryUser = null;

        let localData = {
            contentItems: [],
            categories: [],
            registeredUsers: [{
                username: ADMIN_USER,
                password: ADMIN_PASSWORD,
                name: 'Administrador',
                email: 'admin@portal.com',
                securityQuestion: '¬øCu√°l es tu color favorito?',
                securityAnswer: 'azul',
                profilePicture: null,
                isModerator: false
            }]
        };

        function loadLocalData() {
            const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (saved) localData = JSON.parse(saved);
            loadBlockedUsers();
        }

        function saveLocalData() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localData));
        }

        function loadBlockedUsers() {
            if (currentUser) {
                const saved = localStorage.getItem('blockedUsers_' + currentUser);
                if (saved) blockedUsers = JSON.parse(saved);
            }
        }

        function saveBlockedUsers() {
            if (currentUser) {
                localStorage.setItem('blockedUsers_' + currentUser, JSON.stringify(blockedUsers));
            }
        }

        function loadUserSession() {
            const session = localStorage.getItem(SESSION_KEY);
            if (session) {
                const data = JSON.parse(session);
                currentUser = data.username;
                isAdmin = data.isAdmin;
                const user = localData.registeredUsers.find(u => u.username === currentUser);
                isModerator = user ? user.isModerator : false;
                restoreLoggedInUI();
                return true;
            }
            return false;
        }

        function saveUserSession(username, adminStatus) {
            localStorage.setItem(SESSION_KEY, JSON.stringify({ username, isAdmin: adminStatus }));
        }

        function clearUserSession() {
            localStorage.removeItem(SESSION_KEY);
        }

        function updateUserAvatarDisplay() {
            const user = localData.registeredUsers.find(u => u.username === currentUser);
            if (!user) return;

            const avatarEl = document.getElementById('userAvatar');
            if (user.profilePicture) {
                avatarEl.innerHTML = '<img src="' + user.profilePicture + '" alt="' + currentUser + '">';
            } else {
                avatarEl.textContent = currentUser.charAt(0).toUpperCase();
            }
        }

        function restoreLoggedInUI() {
            document.getElementById('guest-buttons').classList.add('hidden');
            document.getElementById('user-logged').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser;
            updateUserAvatarDisplay();
            
            const user = localData.registeredUsers.find(u => u.username === currentUser);
            isModerator = user ? user.isModerator : false;

            if (isAdmin || isModerator) {
                document.getElementById('adminBadge').classList.remove('hidden');
                if (isAdmin) {
                    document.getElementById('adminBadge').textContent = 'ADMIN';
                } else {
                    document.getElementById('adminBadge').textContent = 'MOD';
                    document.getElementById('adminBadge').style.background = '#4CAF50';
                }
                
                const uploadLink = document.createElement('a');
                uploadLink.href = '#';
                uploadLink.textContent = 'Panel Admin';
                uploadLink.id = 'adminLink';
                uploadLink.onclick = (e) => { e.preventDefault(); showSection('upload'); };
                uploadLink.style.cssText = 'color: #333; text-decoration: none; padding: 10px 20px; border-radius: 5px; transition: all 0.3s;';
                document.querySelector('.nav-links').appendChild(uploadLink);
                
                if (isAdmin) {
                    const moderatorsLink = document.createElement('a');
                    moderatorsLink.href = '#';
                    moderatorsLink.textContent = 'üë• Moderadores';
                    moderatorsLink.id = 'moderatorsLink';
                    moderatorsLink.onclick = (e) => { e.preventDefault(); showModeratorsPanel(); };
                    moderatorsLink.style.cssText = 'color: #333; text-decoration: none; padding: 10px 20px; border-radius: 5px; transition: all 0.3s;';
                    document.querySelector('.nav-links').appendChild(moderatorsLink);
                }
                updateCategorySelect();
            }
            loadBlockedUsers();
            renderGallery();
        }

        function initializeFirebase() {
            const config = {
                apiKey: "AIzaSyC_PRlHwhr7SXpbz_Zdl1Qpxo1vqVSmuhI",
                authDomain: "portal-55679.firebaseapp.com",
                databaseURL: "https://portal-55679-default-rtdb.firebaseio.com",
                projectId: "portal-55679",
                storageBucket: "portal-55679.firebasestorage.app",
                messagingSenderId: "903539413469",
                appId: "1:903539413469:web:697eed91e1f05ba4662634"
            };

            try {
                firebase.initializeApp(config);
                database = firebase.database();
                firebaseInitialized = true;

                database.ref('content').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        localData.contentItems = data.contentItems || [];
                        localData.categories = data.categories || [];
                        updateCategorySelect();
                        updateCategoryFilter();
                        renderGallery();
                        updateStats();
                    }
                });

                database.ref('users').on('value', (snapshot) => {
                    const users = snapshot.val();
                    if (users) localData.registeredUsers = users;
                });

                listenToPrivateMessages();
            } catch (error) {
                console.error('Error Firebase:', error);
            }
        }

        function saveToFirebase() {
            if (firebaseInitialized && database) {
                database.ref('content').set({
                    contentItems: localData.contentItems,
                    categories: localData.categories
                });
                database.ref('users').set(localData.registeredUsers);
            }
        }

        function updateStats() {
            const totalComments = localData.contentItems.reduce((sum, item) => sum + (item.comments?.length || 0), 0);
            document.getElementById('totalPosts').textContent = localData.contentItems.length;
            document.getElementById('totalCategories').textContent = localData.categories.length;
            document.getElementById('totalComments').textContent = totalComments;
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (sectionId === 'home') updateStats();
        }

        function showLogin() {
            document.getElementById('loginModal').classList.add('active');
        }

        function showRegister() {
            document.getElementById('registerModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showMyProfile() {
            if (!currentUser) {
                alert('Inicia sesi√≥n primero');
                return;
            }

            const user = localData.registeredUsers.find(u => u.username === currentUser);
            if (!user) return;

            const preview = document.getElementById('myProfilePicturePreview');
            if (user.profilePicture) {
                preview.innerHTML = '<img src="' + user.profilePicture + '" alt="perfil">';
            } else {
                preview.textContent = currentUser.charAt(0).toUpperCase();
            }

            document.getElementById('myProfileModal').classList.add('active');
        }

        function closeMyProfile() {
            document.getElementById('myProfileModal').classList.remove('active');
        }

        function previewMyProfilePicture() {
            const file = document.getElementById('myProfilePicture').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('myProfilePicturePreview');
                preview.innerHTML = '<img src="' + e.target.result + '" alt="preview">';
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('myProfileForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const user = localData.registeredUsers.find(u => u.username === currentUser);
            if (!user) return;

            const file = document.getElementById('myProfilePicture').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    user.profilePicture = event.target.result;
                    saveLocalData();
                    saveToFirebase();
                    alert('¬°Perfil actualizado!');
                    closeMyProfile();
                    updateUserAvatarDisplay();
                    renderGallery();
                };
                reader.readAsDataURL(file);
            } else {
                alert('Selecciona una foto para tu perfil');
            }
        });

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPassword').value;
            const user = localData.registeredUsers.find(u => u.username === username && u.password === password);

            if (user) {
                const adminStatus = (username === ADMIN_USER);
                currentUser = username;
                isAdmin = adminStatus;
                isModerator = user.isModerator || false;
                saveUserSession(username, adminStatus);
                restoreLoggedInUI();
                listenToPrivateMessages();
                alert('¬°Bienvenido ' + user.name + '!');
                document.getElementById('loginForm').reset();
                closeModal('loginModal');
            } else {
                alert('Usuario o contrase√±a incorrectos');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const username = document.getElementById('registerUser').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const securityQuestion = document.getElementById('registerSecurityQuestion').value;
            const securityAnswer = document.getElementById('registerSecurityAnswer').value.toLowerCase().trim();

            if (localData.registeredUsers.find(u => u.username === username)) {
                alert('Usuario ya existe');
                return;
            }

            localData.registeredUsers.push({
                username, password, name, email, securityQuestion, securityAnswer, profilePicture: null, isModerator: false
            });

            saveLocalData();
            saveToFirebase();
            alert('¬°Cuenta creada!');
            document.getElementById('registerForm').reset();
            closeModal('registerModal');
        });

        function showForgotPassword() {
            closeModal('loginModal');
            document.getElementById('forgotPasswordModal').classList.add('active');
        }

        document.getElementById('forgotPasswordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('forgotUser').value;
            const user = localData.registeredUsers.find(u => u.username === username);

            if (!user || !user.securityQuestion) {
                alert('Usuario no encontrado o sin pregunta de seguridad');
                return;
            }

            recoveryUser = user;
            document.getElementById('securityQuestionLabel').textContent = user.securityQuestion;
            closeModal('forgotPasswordModal');
            document.getElementById('securityQuestionModal').classList.add('active');
            document.getElementById('forgotPasswordForm').reset();
        });

        document.getElementById('securityQuestionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const answer = document.getElementById('securityAnswer').value.toLowerCase().trim();

            if (answer !== recoveryUser.securityAnswer) {
                alert('Respuesta incorrecta');
                return;
            }

            closeModal('securityQuestionModal');
            document.getElementById('resetPasswordModal').classList.add('active');
            document.getElementById('securityQuestionForm').reset();
        });

        document.getElementById('resetPasswordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('Las contrase√±as no coinciden');
                return;
            }

            const userIndex = localData.registeredUsers.findIndex(u => u.username === recoveryUser.username);
            if (userIndex !== -1) {
                localData.registeredUsers[userIndex].password = newPassword;
                saveLocalData();
                saveToFirebase();
                alert('¬°Contrase√±a cambiada!');
                closeModal('resetPasswordModal');
                document.getElementById('resetPasswordForm').reset();
                recoveryUser = null;
                showLogin();
            }
        });

        function logout() {
            currentUser = null;
            isAdmin = false;
            isModerator = false;
            clearUserSession();
            document.getElementById('guest-buttons').classList.remove('hidden');
            document.getElementById('user-logged').classList.add('hidden');
            document.getElementById('adminBadge').classList.add('hidden');
            
            const adminLink = document.getElementById('adminLink');
            if (adminLink) adminLink.remove();
            
            const moderatorsLink = document.getElementById('moderatorsLink');
            if (moderatorsLink) moderatorsLink.remove();
            
            if (isListOpen) toggleChatList();
            if (currentChatRecipient) closePrivateChat();
            
            showSection('home');
            renderGallery();
        }

        function toggleNewCategory() {
            const select = document.getElementById('categorySelect');
            const newInput = document.getElementById('newCategoryInput');
            newInput.classList.toggle('active', select.value === 'nueva');
        }

        function updateCategorySelect() {
            const select = document.getElementById('categorySelect');
            select.innerHTML = '<option value="">Seleccionar...</option>';
            localData.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
            select.innerHTML += '<option value="nueva">‚ûï Nueva categor√≠a</option>';
        }

        function updateCategoryFilter() {
            const filter = document.getElementById('categoryFilter');
            filter.innerHTML = '<button class="category-btn active" onclick="filterByCategory(\'all\')">üìÇ Todas</button>';
            localData.categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.textContent = cat;
                btn.onclick = () => filterByCategory(cat);
                filter.appendChild(btn);
            });
        }

        function filterByCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderGallery();
        }

        function updateUploadForm() {
            const type = document.getElementById('contentType').value;
            const fileArea = document.getElementById('fileInputArea');
            fileArea.style.display = (type === 'info') ? 'none' : 'block';
        }

        document.getElementById('uploadForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!isAdmin && !isModerator) {
                alert('Solo admin y moderadores pueden publicar');
                return;
            }

            const title = document.getElementById('contentTitle').value;
            const description = document.getElementById('contentDescription').value;
            const type = document.getElementById('contentType').value;
            const file = document.getElementById('contentFile').files[0];
            const categorySelect = document.getElementById('categorySelect').value;
            const newCategoryName = document.getElementById('newCategoryName').value.trim();

            let category = '';
            if (categorySelect === 'nueva') {
                if (!newCategoryName) {
                    alert('Ingresa nombre de categor√≠a');
                    return;
                }
                category = newCategoryName;
                if (!localData.categories.includes(category)) {
                    localData.categories.push(category);
                }
            } else if (categorySelect) {
                category = categorySelect;
            } else {
                alert('Selecciona categor√≠a');
                return;
            }

            const processContent = (contentUrl) => {
                const newContent = {
                    id: Date.now(),
                    title, description, type,
                    url: contentUrl,
                    category,
                    user: currentUser,
                    date: new Date().toLocaleDateString(),
                    comments: []
                };
                localData.contentItems.unshift(newContent);
                saveLocalData();
                saveToFirebase();
                updateCategorySelect();
                updateCategoryFilter();
                renderGallery();
                updateStats();
                alert('¬°Publicado!');
                document.getElementById('uploadForm').reset();
                document.getElementById('newCategoryInput').classList.remove('active');
                showSection('gallery');
            };

            if (type === 'info') {
                processContent(null);
            } else if (file) {
                const reader = new FileReader();
                reader.onload = (event) => processContent(event.target.result);
                reader.readAsDataURL(file);
            } else {
                alert('Selecciona un archivo');
            }
        });

        function deletePost(postId) {
            if (!isAdmin) return;
            if (confirm('¬øEliminar publicaci√≥n?')) {
                localData.contentItems = localData.contentItems.filter(item => item.id !== postId);
                saveLocalData();
                saveToFirebase();
                renderGallery();
                updateStats();
            }
        }

        function addComment(postId) {
            if (!currentUser) {
                alert('Inicia sesi√≥n para comentar');
                showLogin();
                return;
            }

            const input = document.getElementById('comment-input-' + postId);
            const text = input.value.trim();

            if (!text) return;

            const post = localData.contentItems.find(item => item.id === postId);
            if (post) {
                if (!post.comments) post.comments = [];
                post.comments.push({
                    id: Date.now(),
                    user: currentUser,
                    text,
                    date: new Date().toLocaleString()
                });
                
                input.value = '';
                saveLocalData();
                saveToFirebase();
                renderGallery();
                updateStats();
            }
        }

        function deleteComment(postId, commentId) {
            if (!isAdmin) return;
            if (confirm('¬øEliminar comentario?')) {
                const post = localData.contentItems.find(item => item.id === postId);
                if (post) {
                    post.comments = post.comments.filter(c => c.id !== commentId);
                    saveLocalData();
                    saveToFirebase();
                    renderGallery();
                    updateStats();
                }
            }
        }

        function shareContent(postId, platform) {
            const post = localData.contentItems.find(item => item.id === postId);
            if (!post) return;

            const shareUrl = window.location.href.split('#')[0] + '#post-' + postId;
            const shareText = post.title + ' - ' + post.description;

            switch(platform) {
                case 'whatsapp':
                    window.open('https://wa.me/?text=' + encodeURIComponent(shareText + ' ' + shareUrl), '_blank');
                    break;
                case 'facebook':
                    window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(shareUrl), '_blank');
                    break;
                case 'twitter':
                    window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(shareText) + '&url=' + encodeURIComponent(shareUrl), '_blank');
                    break;
                case 'copy':
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        const btn = document.getElementById('copy-btn-' + postId);
                        if (btn) {
                            btn.innerHTML = '‚úì ¬°Copiado!';
                            btn.classList.add('copied');
                            setTimeout(() => {
                                btn.innerHTML = 'üìã Copiar';
                                btn.classList.remove('copied');
                            }, 2000);
                        }
                    });
                    break;
            }
        }

        function renderGallery() {
            const grid = document.getElementById('contentGrid');
            grid.innerHTML = '';

            let itemsToShow = currentCategory === 'all' ? 
                localData.contentItems : 
                localData.contentItems.filter(item => item.category === currentCategory);

            if (itemsToShow.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">No hay contenido</p>';
                return;
            }

            itemsToShow.forEach(item => {
                const card = document.createElement('div');
                card.className = 'content-card';
                card.id = 'post-' + item.id;

                let mediaHTML = '';
                if (item.type === 'image') {
                    mediaHTML = '<img src="' + item.url + '" alt="' + item.title + '">';
                } else if (item.type === 'video') {
                    mediaHTML = '<video src="' + item.url + '" controls></video>';
                } else {
                    mediaHTML = '<div style="height: 200px; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">üìÑ</div>';
                }

                let deleteBtn = isAdmin ? '<button class="btn btn-danger delete-post-btn" onclick="deletePost(' + item.id + ')">üóëÔ∏è</button>' : '';
                const categoryBadge = '<div class="category-badge">' + item.category + '</div>';

                let commentsHTML = '<div class="comments-section">';
                commentsHTML += '<strong style="color: #667eea;">üí¨ Comentarios (' + (item.comments?.length || 0) + ')</strong>';

                if (item.comments && item.comments.length > 0) {
                    item.comments.forEach(comment => {
                        let deleteCommentBtn = isAdmin ? '<button class="btn btn-danger btn-small" onclick="deleteComment(' + item.id + ',' + comment.id + ')">üóëÔ∏è</button>' : '';
                        commentsHTML += '<div class="comment">';
                        commentsHTML += '<div class="comment-header">';
                        commentsHTML += '<span class="comment-author username-link" onclick="showUserProfile(\'' + comment.user + '\')">' + comment.user + '</span>';
                        commentsHTML += deleteCommentBtn;
                        commentsHTML += '</div>';
                        commentsHTML += '<p class="comment-text">' + comment.text + '</p>';
                        commentsHTML += '</div>';
                    });
                }

                if (currentUser) {
                    commentsHTML += '<div class="comment-form">';
                    commentsHTML += '<input type="text" class="comment-input" id="comment-input-' + item.id + '" placeholder="Comentar...">';
                    commentsHTML += '<button class="btn btn-primary btn-small" onclick="addComment(' + item.id + ')">üí¨</button>';
                    commentsHTML += '</div>';
                } else {
                    commentsHTML += '<p style="font-size: 12px; color: #999; margin-top: 10px;">Inicia sesi√≥n para comentar</p>';
                }

                commentsHTML += '</div>';

                const shareButtons = '<div class="share-buttons">' +
                    '<button class="btn-share btn-whatsapp" onclick="shareContent(' + item.id + ', \'whatsapp\')">üì± WhatsApp</button>' +
                    '<button class="btn-share btn-facebook" onclick="shareContent(' + item.id + ', \'facebook\')">üìò Facebook</button>' +
                    '<button class="btn-share btn-twitter" onclick="shareContent(' + item.id + ', \'twitter\')">ü¶Ö Twitter</button>' +
                    '<button class="btn-share btn-copy" id="copy-btn-' + item.id + '" onclick="shareContent(' + item.id + ', \'copy\')">üìã Copiar</button>' +
                    '</div>';

                card.innerHTML = categoryBadge + deleteBtn + mediaHTML + 
                    '<div class="content-card-body"><h3>' + item.title + '</h3><p>' + item.description + '</p>' +
                    '<p style="margin-top: 10px; font-size: 12px; color: #999;">Por: ' + item.user + ' | ' + item.date + '</p>' +
                    shareButtons + commentsHTML + '</div>';

                grid.appendChild(card);
            });
        }

        function showUserProfile(username) {
            if (!currentUser) {
                alert('Inicia sesi√≥n para ver perfiles');
                showLogin();
                return;
            }

            if (username === currentUser) {
                alert('No puedes ver tu propio perfil');
                return;
            }

            selectedUserProfile = username;
            const user = localData.registeredUsers.find(u => u.username === username);

            if (!user) {
                alert('Usuario no encontrado: ' + username);
                return;
            }

            // Crear el modal din√°micamente si no existe
            let profileModal = document.getElementById('userProfileModal');
            if (!profileModal) {
                profileModal = document.createElement('div');
                profileModal.id = 'userProfileModal';
                profileModal.className = 'user-profile-modal';
                profileModal.innerHTML = `
                    <div class="user-profile-content">
                        <div class="user-profile-header">
                            <button class="user-profile-close" onclick="closeUserProfile()">√ó</button>
                            <div class="user-profile-avatar" id="profileAvatar">U</div>
                            <div class="user-profile-name" id="profileName">Usuario</div>
                            <div class="user-profile-username" id="profileUsername">@usuario</div>
                        </div>
                        <div class="user-profile-body">
                            <div class="user-profile-info">
                                <div class="user-profile-info-item">
                                    <span>üìß</span>
                                    <span id="profileEmail">email@ejemplo.com</span>
                                </div>
                            </div>
                            <div class="user-profile-actions">
                                <button class="profile-btn profile-btn-message" onclick="startPrivateChat()">üí¨ Enviar mensaje</button>
                                <button class="profile-btn profile-btn-block" id="blockButton" onclick="toggleBlockUser()">üö´ Bloquear</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(profileModal);
            }

            document.getElementById('profileName').textContent = user.name || username;
            document.getElementById('profileUsername').textContent = '@' + username;
            
            // Solo mostrar email si es admin o si es su propia cuenta
            const emailElement = document.getElementById('profileEmail');
            const canSeeEmail = isAdmin || username === currentUser;
            if (canSeeEmail) {
                emailElement.textContent = user.email || 'No disponible';
                emailElement.parentElement.style.display = 'flex';
            } else {
                emailElement.parentElement.style.display = 'none';
            }

            const avatarEl = document.getElementById('profileAvatar');
            if (user.profilePicture) {
                avatarEl.innerHTML = '<img src="' + user.profilePicture + '" alt="' + username + '">';
            } else {
                avatarEl.textContent = username.charAt(0).toUpperCase();
            }

            let blockBtn = document.getElementById('blockButton');
            if (blockedUsers.includes(username)) {
                blockBtn.textContent = '‚úÖ Desbloquear';
                blockBtn.className = 'profile-btn profile-btn-unblock';
            } else {
                blockBtn.textContent = 'üö´ Bloquear';
                blockBtn.className = 'profile-btn profile-btn-block';
            }

            // Agregar opci√≥n de moderador si es admin y el usuario no es admin
            const userProfileActions = document.querySelector('.user-profile-actions');
            if (userProfileActions) {
                let moderatorBtn = userProfileActions.querySelector('[data-mod-btn="true"]');
                
                if (isAdmin && username !== ADMIN_USER) {
                    if (!moderatorBtn) {
                        moderatorBtn = document.createElement('button');
                        moderatorBtn.setAttribute('data-mod-btn', 'true');
                        moderatorBtn.className = 'profile-btn';
                        userProfileActions.appendChild(moderatorBtn);
                    }
                    
                    if (user.isModerator) {
                        moderatorBtn.textContent = 'üë§ Remover Moderador';
                        moderatorBtn.style.background = '#ff9800';
                        moderatorBtn.style.color = 'white';
                        moderatorBtn.onclick = () => {
                            removeModerator(username);
                            showUserProfile(username);
                        };
                    } else {
                        moderatorBtn.textContent = 'üõ°Ô∏è Hacer Moderador';
                        moderatorBtn.style.background = '#2196F3';
                        moderatorBtn.style.color = 'white';
                        moderatorBtn.onclick = () => {
                            makeModerator(username);
                            showUserProfile(username);
                        };
                    }
                } else if (moderatorBtn) {
                    moderatorBtn.remove();
                }
            }

            // Mostrar el modal agregando la clase active
            profileModal.classList.add('active');
        }

        function closeUserProfile() {
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
            selectedUserProfile = null;
        }

        function closeAllModals() {
            const userProfileModal = document.getElementById('userProfileModal');
            if (userProfileModal) {
                userProfileModal.remove();
            }
        }

        function startPrivateChat() {
            if (!selectedUserProfile) {
                alert('No se ha seleccionado ning√∫n usuario');
                return;
            }

            if (blockedUsers.includes(selectedUserProfile)) {
                alert('Desbloquea primero a este usuario para enviarle mensajes');
                return;
            }

            const recipientUser = localData.registeredUsers.find(u => u.username === selectedUserProfile);
            if (!recipientUser) {
                alert('El usuario ya no est√° disponible');
                closeUserProfile();
                return;
            }

            closeUserProfile();
            
            if (!isListOpen) {
                toggleChatList();
            }
            
            setTimeout(() => {
                openPrivateChat(selectedUserProfile);
            }, 100);
        }

        function makeModerator(username) {
            if (!isAdmin) {
                alert('Solo el admin puede hacer moderadores');
                return;
            }

            const user = localData.registeredUsers.find(u => u.username === username);
            if (!user) return;

            user.isModerator = true;
            saveLocalData();
            saveToFirebase();
            alert('¬°' + username + ' ahora es moderador!');
        }

        function removeModerator(username) {
            if (!isAdmin) {
                alert('Solo el admin puede remover moderadores');
                return;
            }

            const user = localData.registeredUsers.find(u => u.username === username);
            if (!user) return;

            user.isModerator = false;
            saveLocalData();
            saveToFirebase();
            alert('¬°' + username + ' ha sido degradado a usuario com√∫n!');
        }

        function showModeratorsPanel() {
            if (!isAdmin) {
                alert('Solo el admin puede acceder a este panel');
                return;
            }

            const modal = document.getElementById('moderatorsModal');
            if (modal) {
                modal.classList.add('active');
                renderModeratorsPanel();
            } else {
                console.error('Modal de moderadores no encontrado');
            }
        }

        function closeModeratorsPanel() {
            const modal = document.getElementById('moderatorsModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function renderModeratorsPanel() {
            const moderatorsList = document.getElementById('moderatorsList');
            const usersToPromoteList = document.getElementById('usersToPromoteList');
            
            if (!moderatorsList || !usersToPromoteList) {
                console.error('Elementos del panel de moderadores no encontrados');
                return;
            }

            const moderators = localData.registeredUsers.filter(u => u.isModerator);

            if (moderators.length === 0) {
                moderatorsList.innerHTML = '<p style="color: #999;">No hay moderadores registrados</p>';
            } else {
                moderatorsList.innerHTML = '';
                moderators.forEach(mod => {
                    const div = document.createElement('div');
                    div.style.cssText = 'background: #f0f0f0; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;';
                    div.innerHTML = `
                        <div>
                            <strong>${mod.name}</strong> <br>
                            <small style="color: #666;">@${mod.username}</small>
                        </div>
                        <button class="btn btn-danger" onclick="removeModerator('${mod.username}'); renderModeratorsPanel(); renderUsersToPromote();">Remover</button>
                    `;
                    moderatorsList.appendChild(div);
                });
            }

            renderUsersToPromote();
        }

        function renderUsersToPromote() {
            const usersToPromoteList = document.getElementById('usersToPromoteList');
            if (!usersToPromoteList) {
                console.error('Elemento usersToPromoteList no encontrado');
                return;
            }

            const nonModerators = localData.registeredUsers.filter(u => !u.isModerator && u.username !== ADMIN_USER);

            if (nonModerators.length === 0) {
                usersToPromoteList.innerHTML = '<p style="color: #999;">Todos los usuarios son moderadores</p>';
            } else {
                usersToPromoteList.innerHTML = '';
                nonModerators.forEach(user => {
                    const div = document.createElement('div');
                    div.style.cssText = 'background: #f9f9f9; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;';
                    div.innerHTML = `
                        <div>
                            <strong>${user.name}</strong> <br>
                            <small style="color: #666;">@${user.username}</small>
                        </div>
                        <button class="btn btn-primary" onclick="makeModerator('${user.username}'); renderModeratorsPanel(); renderUsersToPromote();">Hacer MOD</button>
                    `;
                    usersToPromoteList.appendChild(div);
                });
            }
        }

        function toggleBlockUser() {
            if (!selectedUserProfile) return;

            if (blockedUsers.includes(selectedUserProfile)) {
                blockedUsers = blockedUsers.filter(u => u !== selectedUserProfile);
                alert('Usuario ' + selectedUserProfile + ' desbloqueado. Ahora puedes recibir mensajes de este usuario.');
                document.getElementById('blockButton').textContent = 'üö´ Bloquear';
                document.getElementById('blockButton').className = 'profile-btn profile-btn-block';
            } else {
                blockedUsers.push(selectedUserProfile);
                alert('Usuario ' + selectedUserProfile + ' bloqueado. No recibir√°s m√°s mensajes de este usuario.');
                document.getElementById('blockButton').textContent = '‚úÖ Desbloquear';
                document.getElementById('blockButton').className = 'profile-btn profile-btn-unblock';

                if (currentChatRecipient === selectedUserProfile) {
                    closePrivateChat();
                }
            }

            saveBlockedUsers();
            updateConversationsList();
        }

        function toggleChatList() {
            if (!currentUser) {
                alert('Inicia sesi√≥n para chatear');
                showLogin();
                return;
            }

            isListOpen = !isListOpen;
            const chatListWindow = document.getElementById('chatListWindow');

            if (isListOpen) {
                chatListWindow.classList.add('active');
                updateConversationsList();
            } else {
                chatListWindow.classList.remove('active');
            }
        }

        function updateConversationsList() {
            const container = document.getElementById('conversationsList');

            const allUsers = localData.registeredUsers.filter(u =>
                u.username !== currentUser &&
                !blockedUsers.includes(u.username)
            );

            if (allUsers.length === 0) {
                container.innerHTML = '<div class="no-conversations"><p>No hay usuarios disponibles</p></div>';
                return;
            }

            const conversationsWithMessages = [];
            const conversationsWithoutMessages = [];

            allUsers.forEach(user => {
                const convId = getConversationId(currentUser, user.username);
                const unreadCount = conversations[convId]?.unread || 0;
                const lastMessage = conversations[convId]?.lastMessage || null;

                const userData = { user, unreadCount, lastMessage };

                if (lastMessage) {
                    conversationsWithMessages.push(userData);
                } else {
                    conversationsWithoutMessages.push(userData);
                }
            });

            conversationsWithMessages.sort((a, b) => b.lastMessage.timestamp - a.lastMessage.timestamp);

            const sortedUsers = [...conversationsWithMessages, ...conversationsWithoutMessages];

            container.innerHTML = '';

            sortedUsers.forEach(({ user, unreadCount, lastMessage }) => {
                const convItem = document.createElement('div');
                convItem.className = 'conversation-item';
                if (currentChatRecipient === user.username) {
                    convItem.classList.add('active');
                }

                const avatar = document.createElement('div');
                avatar.className = 'conversation-avatar';
                if (user.profilePicture) {
                    avatar.innerHTML = '<img src="' + user.profilePicture + '" alt="' + user.username + '">';
                } else {
                    avatar.textContent = user.username.charAt(0).toUpperCase();
                }

                const info = document.createElement('div');
                info.className = 'conversation-info';

                const name = document.createElement('div');
                name.className = 'conversation-name';
                name.textContent = user.name;

                const preview = document.createElement('div');
                preview.className = 'conversation-preview';
                preview.textContent = lastMessage ? lastMessage.preview : 'Iniciar conversaci√≥n';

                info.appendChild(name);
                info.appendChild(preview);

                convItem.appendChild(avatar);
                convItem.appendChild(info);

                if (unreadCount > 0) {
                    const badge = document.createElement('div');
                    badge.className = 'conversation-unread';
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    convItem.appendChild(badge);
                }

                convItem.onclick = () => openPrivateChat(user.username);

                container.appendChild(convItem);
            });
        }

        function getConversationId(user1, user2) {
            return [user1, user2].sort().join('_');
        }

        function openPrivateChat(recipientUsername) {
            if (blockedUsers.includes(recipientUsername)) {
                alert('Has bloqueado a este usuario');
                return;
            }

            currentChatRecipient = recipientUsername;
            const recipient = localData.registeredUsers.find(u => u.username === recipientUsername);

            if (!recipient) {
                alert('Usuario no encontrado');
                return;
            }

            document.getElementById('chatRecipientName').textContent = recipient.name;
            document.getElementById('chatWindow').classList.add('active');

            const convId = getConversationId(currentUser, recipientUsername);
            if (conversations[convId]) {
                conversations[convId].unread = 0;
            }

            renderPrivateMessages();
            updateConversationsList();
            updateChatNotification();

            setTimeout(() => {
                document.getElementById('chatInput').focus();
                scrollChatToBottom();
            }, 100);
        }

        function closePrivateChat() {
            document.getElementById('chatWindow').classList.remove('active');
            currentChatRecipient = null;
        }

        function backToConversations() {
            closePrivateChat();
            if (!isListOpen) {
                toggleChatList();
            }
        }

        function listenToPrivateMessages() {
            if (!firebaseInitialized || !database || !currentUser) return;

            database.ref('privateMessages').on('value', (snapshot) => {
                const allMessages = snapshot.val();
                if (!allMessages) return;

                conversations = {};
                let totalUnread = 0;

                Object.keys(allMessages).forEach(convId => {
                    const [user1, user2] = convId.split('_');

                    if (user1 !== currentUser && user2 !== currentUser) return;

                    const otherUser = user1 === currentUser ? user2 : user1;

                    if (blockedUsers.includes(otherUser)) return;

                    const messages = Object.values(allMessages[convId]).sort((a, b) => a.timestamp - b.timestamp);

                    const unreadCount = messages.filter(msg =>
                        msg.to === currentUser &&
                        !msg.read &&
                        msg.from !== currentUser
                    ).length;

                    const lastMsg = messages[messages.length - 1];

                    conversations[convId] = {
                        messages: messages,
                        unread: unreadCount,
                        lastMessage: {
                            preview: lastMsg.text.substring(0, 40) + (lastMsg.text.length > 40 ? '...' : ''),
                            timestamp: lastMsg.timestamp
                        }
                    };

                    totalUnread += unreadCount;
                });

                unreadMessages = totalUnread;
                updateChatNotification();

                if (currentChatRecipient) {
                    renderPrivateMessages();
                    markMessagesAsRead(currentChatRecipient);
                }

                if (isListOpen) {
                    updateConversationsList();
                }
            });
        }

        function renderPrivateMessages() {
            if (!currentChatRecipient) return;

            const container = document.getElementById('chatMessages');
            const convId = getConversationId(currentUser, currentChatRecipient);
            const conversation = conversations[convId];

            if (!conversation || conversation.messages.length === 0) {
                container.innerHTML = '<div class="empty-chat"><div class="empty-chat-icon">üí¨</div><p>No hay mensajes</p><p style="font-size: 12px; color: #ccc;">¬°Env√≠a el primero!</p></div>';
                return;
            }

            const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;

            container.innerHTML = '';

            conversation.messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message' + (msg.from === currentUser ? ' own' : '');

                const authorDiv = document.createElement('div');
                authorDiv.className = 'message-author';
                authorDiv.textContent = msg.from === currentUser ? 'T√∫' : msg.from;

                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message-bubble';
                bubbleDiv.textContent = msg.text;

                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date(msg.timestamp).toLocaleTimeString();

                messageDiv.appendChild(authorDiv);
                messageDiv.appendChild(bubbleDiv);
                messageDiv.appendChild(timeDiv);

                container.appendChild(messageDiv);
            });

            if (wasAtBottom) {
                setTimeout(() => scrollChatToBottom(), 100);
            }
        }

        function sendPrivateMessage() {
            if (!currentUser || !currentChatRecipient) return;

            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            if (blockedUsers.includes(currentChatRecipient)) {
                alert('No puedes enviar mensajes a un usuario bloqueado');
                return;
            }

            const convId = getConversationId(currentUser, currentChatRecipient);

            const newMessage = {
                from: currentUser,
                to: currentChatRecipient,
                text: message,
                timestamp: Date.now(),
                read: false
            };

            if (firebaseInitialized && database) {
                database.ref('privateMessages/' + convId).push(newMessage)
                    .then(() => {
                        input.value = '';
                        scrollChatToBottom();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al enviar');
                    });
            }
        }

        function markMessagesAsRead(senderUsername) {
            if (!firebaseInitialized || !database || !currentUser) return;

            const convId = getConversationId(currentUser, senderUsername);
            const conversation = conversations[convId];

            if (!conversation) return;

            conversation.messages.forEach(msg => {
                if (msg.to === currentUser && !msg.read && msg.from === senderUsername) {
                    database.ref('privateMessages/' + convId).orderByChild('timestamp').equalTo(msg.timestamp).once('value', (snapshot) => {
                        snapshot.forEach((childSnapshot) => {
                            childSnapshot.ref.update({ read: true });
                        });
                    });
                }
            });
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendPrivateMessage();
            }
        }

        function scrollChatToBottom() {
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        }

        function updateChatNotification() {
            const badge = document.getElementById('chatNotification');
            if (unreadMessages > 0) {
                badge.textContent = unreadMessages > 99 ? '99+' : unreadMessages;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        loadLocalData();

        function waitForFirebase() {
            if (typeof firebase !== 'undefined') {
                loadUserSession();
                initializeFirebase();
                closeAllModals();
            } else {
                setTimeout(waitForFirebase, 100);
            }
        }

        waitForFirebase();

        updateCategoryFilter();
        renderGallery();
        updateStats();
        closeAllModals();

        window.addEventListener('load', () => {
            closeAllModals();
            const hash = window.location.hash;
            if (hash && hash.startsWith('#post-')) {
                setTimeout(() => {
                    const element = document.querySelector(hash);
                    if (element) {
                        showSection('gallery');
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        element.style.animation = 'highlight 2s ease';
                    }
                }, 4500);
            }
        });

        const style = document.createElement('style');
        style.textContent = '@keyframes highlight { 0%, 100% { box-shadow: 0 5px 20px rgba(0,0,0,0.1); } 50% { box-shadow: 0 5px 30px rgba(102, 126, 234, 0.5); transform: scale(1.02); } }';
        document.head.appendChild(style);
    </script>
</body>
</html>
