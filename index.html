<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: fadeOut 1s ease 3s forwards;
        }
        @keyframes fadeOut { to { opacity: 0; pointer-events: none; } }
        .anime-character { text-align: center; animation: bounceIn 0.8s ease; }
        @keyframes bounceIn {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .character-img {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 120px;
            margin: 0 auto 20px;
        }
        .speech-bubble {
            background: white;
            padding: 20px 30px;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: popIn 0.5s ease 0.5s backwards;
        }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .speech-bubble::before {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            border: 10px solid transparent;
            border-top-color: white;
        }
        .speech-bubble h2 { color: #667eea; margin-bottom: 10px; }
        .speech-bubble p { color: #666; }
        #main-content {
            opacity: 0;
            animation: fadeIn 1s ease 4s forwards;
            padding: 20px;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-radius: 10px;
        }
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .logo { font-size: 24px; font-weight: bold; color: #667eea; }
        .nav-links { display: flex; gap: 20px; flex-wrap: wrap; }
        .nav-links a {
            color: #333;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .nav-links a:hover { background: #667eea; color: white; }
        .user-info { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-secondary:hover { background: #667eea; color: white; }
        .btn-danger { background: #ff6b6b; color: white; padding: 5px 10px; font-size: 12px; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .section { display: none; }
        .section.active { display: block; }
        h1 { color: #667eea; margin-bottom: 20px; }
        .hidden { display: none !important; }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
        }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .admin-badge { background: #ff6b6b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #667eea; }
        .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; color: #333; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .stats-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
        .stat-item { text-align: center; }
        .stat-number { font-size: 28px; font-weight: bold; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .content-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s;
            background: white;
            position: relative;
        }
        .content-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .content-card img, .content-card video { width: 100%; height: 200px; object-fit: cover; }
        .content-card-body { padding: 15px; }
        .content-card-body h3 { color: #333; margin-bottom: 10px; }
        .content-card-body p { color: #666; font-size: 14px; }
        .category-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            z-index: 5;
        }
        .delete-post-btn { position: absolute; top: 10px; right: 10px; z-index: 10; }
        .category-filter { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .category-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .category-btn:hover, .category-btn.active { background: #667eea; color: white; }
        .new-category-input { display: none; margin-top: 10px; }
        .new-category-input.active { display: block; }
        .comments-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .comment { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px; position: relative; }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .comment-author { font-weight: bold; color: #667eea; font-size: 13px; cursor: pointer; }
        .comment-text { color: #333; font-size: 13px; }
        .comment-form { margin-top: 10px; display: flex; gap: 5px; }
        .comment-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; }
        .share-buttons { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .btn-share {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        .btn-whatsapp { background: #25D366; color: white; }
        .btn-facebook { background: #1877F2; color: white; }
        .btn-twitter { background: #1DA1F2; color: white; }
        .btn-copy { background: #6c757d; color: white; }
        .btn-copy.copied { background: #28a745; }
        .chat-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-button:hover { transform: scale(1.1); }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .chat-list-window, .chat-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 998;
            overflow: hidden;
        }
        .chat-window { right: 400px; z-index: 997; }
        .chat-list-window.active, .chat-window.active { display: flex; }
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-header h3 { margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        .chat-conversations-list { flex: 1; overflow-y: auto; background: #f8f9fa; }
        .conversation-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }
        .conversation-item:hover { background: #e9ecef; }
        .conversation-item.active { background: #e7e9fc; }
        .conversation-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            overflow: hidden;
        }
        .conversation-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .conversation-info { flex: 1; min-width: 0; }
        .conversation-name { font-weight: bold; color: #333; margin-bottom: 3px; }
        .conversation-preview {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .conversation-unread {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; background: #f8f9fa; }
        .chat-message { margin-bottom: 15px; }
        .chat-message.own { text-align: right; }
        .chat-message .message-author { font-size: 12px; color: #667eea; font-weight: bold; margin-bottom: 3px; }
        .chat-message.own .message-author { color: #764ba2; }
        .chat-message .message-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }
        .chat-message.own .message-bubble { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .chat-message .message-time { font-size: 10px; color: #999; margin-top: 3px; }
        .chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
        }
        .chat-send {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .user-profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        .user-profile-modal.active { display: flex; }
        .user-profile-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }
        .user-profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px 20px;
            text-align: center;
            color: white;
            position: relative;
        }
        .user-profile-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
        }
        .user-profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #667eea;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .user-profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-profile-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
        .user-profile-username { font-size: 14px; opacity: 0.9; }
        .user-profile-body { padding: 25px; }
        .user-profile-actions { display: flex; gap: 10px; flex-direction: column; }
        .profile-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .profile-btn-message { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .profile-btn-block { background: #ff6b6b; color: white; }
        .profile-btn-unblock { background: #28a745; color: white; }
        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            padding: 20px;
            text-align: center;
        }
        .empty-chat-icon { font-size: 64px; margin-bottom: 15px; opacity: 0.5; }
        .mod-user-card {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .mod-user-card.promote {
            background: #f9f9f9;
        }
        .profile-picture-area {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .profile-picture-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
            border: 3px solid #667eea;
            overflow: hidden;
            font-weight: bold;
        }
        .profile-picture-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }
        .image-fullscreen-overlay.active {
            display: flex;
        }
        .image-fullscreen-overlay img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }
        .image-fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 36px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .image-fullscreen-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        @media (max-width: 768px) {
            .chat-list-window, .chat-window { 
                bottom: 90px; 
                right: 10px; 
                left: 10px; 
                width: auto; 
                height: 450px; 
            }
            .chat-window { right: 10px; }
            .content-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="welcome-screen">
        <div class="anime-character">
            <div class="character-img">üå∏</div>
            <div class="speech-bubble">
                <h2>¬°Hello World! </h2>
                <p>Bienvenido al portal</p>
            </div>
        </div>
    </div>

    <div id="main-content">
        <header>
            <nav>
                <div class="logo">üå∏ Portal</div>
                <div class="nav-links" id="navLinks">
                    <a href="#" onclick="showSection('home'); return false;">Inicio</a>
                    <a href="#" onclick="showSection('gallery'); return false;">Galer√≠a</a>
                </div>
                <div class="user-info">
                    <div id="guest-buttons">
                        <button class="btn btn-primary" onclick="showLogin()">Iniciar Sesi√≥n</button>
                        <button class="btn btn-secondary" onclick="showRegister()">Registrarse</button>
                    </div>
                    <div id="user-logged" class="hidden">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <span id="userName"></span>
                        <span id="adminBadge" class="admin-badge hidden">ADMIN</span>
                        <button class="btn btn-secondary" onclick="showMyProfile()">Mi Perfil</button>
                        <button class="btn btn-secondary" onclick="logout()">Salir</button>
                    </div>
                </div>
            </nav>
        </header>

        <div class="container">
            <section id="home" class="section active">
                <h1>¬°Bienvenido al Portal! üéå</h1>
                <div class="stats-banner">
                    <div class="stat-item">
                        <div class="stat-number" id="totalPosts">0</div>
                        <div class="stat-label">Publicaciones</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalCategories">0</div>
                        <div class="stat-label">Categor√≠as</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalComments">0</div>
                        <div class="stat-label">Comentarios</div>
                    </div>
                </div>
                <p>Este es un espacio para compartir contenido.</p>
                <p><strong>Reg√≠strate</strong> para comentar y chatear.</p>
            </section>

            <section id="upload" class="section">
                <h1>Panel de Administrador </h1>
                <form id="uploadForm">
                    <div class="form-group">
                        <label>Tipo:</label>
                        <select id="contentType" onchange="updateUploadForm()">
                            <option value="image">Imagen</option>
                            <option value="video">Video</option>
                            <option value="info">Info</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>T√≠tulo:</label>
                        <input type="text" id="contentTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n:</label>
                        <textarea id="contentDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a:</label>
                        <select id="categorySelect" onchange="toggleNewCategory()">
                            <option value="">Seleccionar...</option>
                            <option value="nueva">‚ûï Nueva categor√≠a</option>
                        </select>
                        <div class="new-category-input" id="newCategoryInput">
                            <input type="text" id="newCategoryName" placeholder="Nombre de la categor√≠a">
                        </div>
                    </div>
                    <div id="fileInputArea" class="form-group">
                        <label>Archivo:</label>
                        <input type="file" id="contentFile" accept="image/*,video/*">
                    </div>
                    <button type="submit" class="btn btn-primary">Publicar</button>
                </form>
            </section>

            <section id="gallery" class="section">
                <h1>Galer√≠a </h1>
                <div class="category-filter" id="categoryFilter">
                    <button class="category-btn active" onclick="filterByCategory('all')">üìÇ Todas</button>
                </div>
                <div class="content-grid" id="contentGrid"></div>
            </section>

            <section id="moderators" class="section">
                <h1>Gestionar Moderadores </h1>
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Moderadores Actuales üõ°Ô∏è</h3>
                    <div id="moderatorsList"></div>
                </div>
                <hr style="border: 1px solid #ddd; margin: 30px 0;">
                <div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">Promover a Moderador </h3>
                    <div id="usersToPromoteList"></div>
                </div>
            </section>
        </div>
    </div>

    <div class="modal" id="myProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Mi Perfil</h2>
                <button class="close-modal" onclick="closeModal('myProfileModal')">&times;</button>
            </div>
            <form id="myProfileForm">
                <div class="profile-picture-area">
                    <div class="profile-picture-preview" id="myProfilePicturePreview">üë§</div>
                    <label style="display: block; margin-bottom: 10px; color: #333; font-weight: bold;">
                        Foto de Perfil:
                    </label>
                    <input type="file" id="myProfilePicture" accept="image/*" onchange="previewMyProfilePicture()">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div class="image-fullscreen-overlay" id="imageFullscreenOverlay" onclick="closeFullscreenImage()">
        <button class="image-fullscreen-close" onclick="closeFullscreenImage(); event.stopPropagation();">√ó</button>
        <img id="fullscreenImage" src="" alt="Imagen en pantalla completa">
    </div>

    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Iniciar Sesi√≥n</h2>
                <button class="close-modal" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Usuario:</label>
                    <input type="text" id="loginUser" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button>
                <a class="forgot-password-link" onclick="showForgotPassword()" style="display: block; text-align: center; margin-top: 15px; color: #667eea; cursor: pointer; text-decoration: none;">¬øOlvidaste tu contrase√±a?</a>
            </form>
        </div>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrarse</h2>
                <button class="close-modal" onclick="closeModal('registerModal')">&times;</button>
            </div>
            <form id="registerForm">
                <div class="form-group">
                    <label>Nombre:</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label>Usuario:</label>
                    <input type="text" id="registerUser" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label>Pregunta de Seguridad:</label>
                    <select id="registerSecurityQuestion" required>
                        <option value="">Selecciona una pregunta...</option>
                        <option value="¬øCu√°l es el nombre de tu primera mascota?">¬øCu√°l es el nombre de tu primera mascota?</option>
                        <option value="¬øCu√°l es tu comida favorita?">¬øCu√°l es tu comida favorita?</option>
                        <option value="¬øEn qu√© ciudad naciste?">¬øEn qu√© ciudad naciste?</option>
                        <option value="¬øCu√°l es tu color favorito?">¬øCu√°l es tu color favorito?</option>
                        <option value="¬øCu√°l es el nombre de tu mejor amigo de la infancia?">¬øCu√°l es el nombre de tu mejor amigo de la infancia?</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Respuesta de Seguridad:</label>
                    <input type="text" id="registerSecurityAnswer" required placeholder="Escribe tu respuesta">
                </div>
                <div class="form-group">
                    <label>Contrase√±a:</label>
                    <input type="password" id="registerPassword" required minlength="4">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Crear Cuenta</button>
            </form>
        </div>
    </div>

    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Recuperar Contrase√±a</h2>
                <button class="close-modal" onclick="closeModal('forgotPasswordModal')">&times;</button>
            </div>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label>Usuario:</label>
                    <input type="text" id="forgotUser" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Siguiente</button>
            </form>
        </div>
    </div>

    <div class="modal" id="securityQuestionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Pregunta de Seguridad</h2>
                <button class="close-modal" onclick="closeModal('securityQuestionModal')">&times;</button>
            </div>
            <form id="securityQuestionForm">
                <div class="form-group">
                    <label id="securityQuestionLabel"></label>
                    <input type="text" id="securityAnswer" required placeholder="Escribe tu respuesta">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Verificar</button>
            </form>
        </div>
    </div>

    <div class="modal" id="resetPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nueva Contrase√±a</h2>
                <button class="close-modal" onclick="closeModal('resetPasswordModal')">&times;</button>
            </div>
            <form id="resetPasswordForm">
                <div class="form-group">
                    <label>Nueva Contrase√±a:</label>
                    <input type="password" id="newPassword" required minlength="4">
                </div>
                <div class="form-group">
                    <label>Confirmar Contrase√±a:</label>
                    <input type="password" id="confirmPassword" required minlength="4">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Cambiar Contrase√±a</button>
            </form>
        </div>
    </div>

    <button class="chat-button" onclick="toggleChatList()">
        üí¨
        <span class="notification-badge hidden" id="chatNotification">0</span>
    </button>

    <div class="chat-list-window" id="chatListWindow">
        <div class="chat-header">
            <h3>üí¨ Mensajes</h3>
            <button class="chat-close" onclick="toggleChatList()">√ó</button>
        </div>
        <div class="chat-conversations-list" id="conversationsList"></div>
    </div>

    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <h3>
                <button onclick="backToConversations()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚Üê</button>
                <span id="chatRecipientName"></span>
            </h3>
            <button class="chat-close" onclick="closePrivateChat()">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Escribe..." onkeypress="if(event.key==='Enter') sendPrivateMessage()">
            <button class="chat-send" onclick="sendPrivateMessage()">üì§</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const ADMIN_USER = 'Inder';
        const ADMIN_PASSWORD = 'admin123';
        
        // Configuraci√≥n de Cloudinary
        const CLOUDINARY_CLOUD_NAME = 'dlpwrcojl';
        const CLOUDINARY_UPLOAD_PRESET = 'Portal';
        
        let currentUser = null;
        let isAdmin = false;
        let isModerator = false;
        let currentCategory = 'all';
        let database = null;
        let storage = null;
        let firebaseInitialized = false;
        let currentChatRecipient = null;
        let selectedUserProfile = null;
        let conversations = {};
        let blockedUsers = [];
        let unreadMessages = 0;
        let isListOpen = false;
        let recoveryUser = null;

        let localData = {
            contentItems: [],
            categories: [],
            registeredUsers: [{
                username: ADMIN_USER,
                password: ADMIN_PASSWORD,
                name: 'Administrador',
                email: 'admin@portal.com',
                isModerator: false,
                profilePicture: null,
                securityQuestion: '¬øCu√°l es tu color favorito?',
                securityAnswer: 'azul'
            }]
        };

        function isStaff(username) {
            if (username === ADMIN_USER) return true;
            const user = localData.registeredUsers.find(u => u.username === username);
            return user && user.isModerator;
        }

        function loadLocalData() {
            const saved = localStorage.getItem('portalData');
            if (saved) localData = JSON.parse(saved);
        }

        function saveLocalData() {
            localStorage.setItem('portalData', JSON.stringify(localData));
        }

        function loadUserSession() {
            const session = localStorage.getItem('userSession');
            if (session) {
                const data = JSON.parse(session);
                currentUser = data.username;
                isAdmin = data.isAdmin;
                const user = localData.registeredUsers.find(u => u.username === currentUser);
                isModerator = user ? user.isModerator : false;
                restoreUI();
                return true;
            }
            return false;
        }

        function saveUserSession(username, adminStatus) {
            localStorage.setItem('userSession', JSON.stringify({ username, isAdmin: adminStatus }));
        }

        function restoreUI() {
            document.getElementById('guest-buttons').classList.add('hidden');
            document.getElementById('user-logged').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser;
            
            // Actualizar avatar con foto de perfil
            updateUserAvatarDisplay();
            
            if (isAdmin || isModerator) {
                document.getElementById('adminBadge').classList.remove('hidden');
                document.getElementById('adminBadge').textContent = isAdmin ? 'ADMIN' : 'MOD';
                document.getElementById('adminBadge').style.background = isAdmin ? '#ff6b6b' : '#4CAF50';
                
                const uploadLink = document.createElement('a');
                uploadLink.href = '#';
                uploadLink.textContent = 'Panel Admin';
                uploadLink.id = 'adminLink';
                uploadLink.onclick = (e) => { e.preventDefault(); showSection('upload'); };
                document.querySelector('#navLinks').appendChild(uploadLink);
                
                if (isAdmin) {
                    const moderatorsLink = document.createElement('a');
                    moderatorsLink.href = '#';
                    moderatorsLink.textContent = ' Moderadores';
                    moderatorsLink.id = 'moderatorsLink';
                    moderatorsLink.onclick = (e) => { e.preventDefault(); showSection('moderators'); renderModeratorsPanel(); };
                    document.querySelector('#navLinks').appendChild(moderatorsLink);
                }
                
                updateCategorySelect();
            }
            renderGallery();
        }

        function updateUserAvatarDisplay() {
            const user = localData.registeredUsers.find(u => u.username === currentUser);
            if (!user) return;

            const avatarEl = document.getElementById('userAvatar');
            if (user.profilePicture) {
                avatarEl.innerHTML = '<img src="' + user.profilePicture + '" alt="' + currentUser + '">';
            } else {
                avatarEl.innerHTML = '';
                avatarEl.textContent = currentUser.charAt(0).toUpperCase();
            }
        }

        function showMyProfile() {
            if (!currentUser) {
                alert('Inicia sesi√≥n primero');
                return;
            }

            const user = localData.registeredUsers.find(u => u.username === currentUser);
            if (!user) return;

            const preview = document.getElementById('myProfilePicturePreview');
            if (user.profilePicture) {
                preview.innerHTML = '<img src="' + user.profilePicture + '" alt="perfil">';
            } else {
                preview.innerHTML = '';
                preview.textContent = currentUser.charAt(0).toUpperCase();
            }

            document.getElementById('myProfileModal').classList.add('active');
        }

        function previewMyProfilePicture() {
            const file = document.getElementById('myProfilePicture').files[0];
            if (!file) return;

            // Validar tama√±o (m√°ximo 5MB para foto de perfil con Cloudinary)
            if (file.size > 5 * 1024 * 1024) {
                alert('La imagen es muy grande. M√°ximo 5MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('myProfilePicturePreview');
                preview.innerHTML = '<img src="' + e.target.result + '" alt="preview">';
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('myProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const user = localData.registeredUsers.find(u => u.username === currentUser);
            if (!user) return;

            const file = document.getElementById('myProfilePicture').files[0];
            if (file) {
                // Subir foto de perfil a Cloudinary
                const progressMsg = document.createElement('div');
                progressMsg.id = 'uploadProgressMsg';
                progressMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #667eea; color: white; padding: 15px 25px; border-radius: 10px; z-index: 10000; box-shadow: 0 5px 20px rgba(0,0,0,0.3);';
                progressMsg.innerHTML = '<strong>üì§ Subiendo foto...</strong><br><span id="uploadProgress">Procesando...</span>';
                document.body.appendChild(progressMsg);

                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);
                    formData.append('folder', 'portal/profiles');
                    formData.append('transformation', 'c_fill,w_200,h_200,g_face'); // Optimizar para perfiles

                    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const msg = document.getElementById('uploadProgressMsg');
                    if (msg) document.body.removeChild(msg);

                    if (response.ok) {
                        const data = await response.json();
                        user.profilePicture = data.secure_url;
                        saveLocalData();
                        saveToFirebase();
                        alert('¬°Perfil actualizado!');
                        closeModal('myProfileModal');
                        updateUserAvatarDisplay();
                        renderGallery();
                    } else {
                        alert('Error al subir la foto. Intenta de nuevo.');
                    }
                } catch (error) {
                    const msg = document.getElementById('uploadProgressMsg');
                    if (msg) document.body.removeChild(msg);
                    console.error('Error:', error);
                    alert('Error al subir la foto: ' + error.message);
                }
            } else {
                alert('Selecciona una foto para tu perfil');
            }
        });

        function initFirebase() {
            try {
                firebase.initializeApp({
                    apiKey: "AIzaSyC_PRlHwhr7SXpbz_Zdl1Qpxo1vqVSmuhI",
                    authDomain: "portal-55679.firebaseapp.com",
                    databaseURL: "https://portal-55679-default-rtdb.firebaseio.com",
                    projectId: "portal-55679",
                    storageBucket: "portal-55679.firebasestorage.app",
                    messagingSenderId: "903539413469",
                    appId: "1:903539413469:web:697eed91e1f05ba4662634"
                });
                database = firebase.database();
                firebaseInitialized = true;

                database.ref('content').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        localData.contentItems = data.contentItems || [];
                        localData.categories = data.categories || [];
                        updateCategorySelect();
                        updateCategoryFilter();
                        renderGallery();
                        updateStats();
                    }
                });

                database.ref('users').on('value', (snapshot) => {
                    const users = snapshot.val();
                    if (users) localData.registeredUsers = users;
                });

                listenToMessages();
            } catch (error) {
                console.error('Firebase error:', error);
            }
        }

        function saveToFirebase() {
            if (firebaseInitialized && database) {
                database.ref('content').set({
                    contentItems: localData.contentItems,
                    categories: localData.categories
                });
                database.ref('users').set(localData.registeredUsers);
            }
        }

        function updateStats() {
            const totalComments = localData.contentItems.reduce((sum, item) => sum + (item.comments?.length || 0), 0);
            document.getElementById('totalPosts').textContent = localData.contentItems.length;
            document.getElementById('totalCategories').textContent = localData.categories.length;
            document.getElementById('totalComments').textContent = totalComments;
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (sectionId === 'home') updateStats();
        }

        function showLogin() {
            document.getElementById('loginModal').classList.add('active');
        }

        function showRegister() {
            document.getElementById('registerModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPassword').value;
            const user = localData.registeredUsers.find(u => u.username === username && u.password === password);

            if (user) {
                const adminStatus = (username === ADMIN_USER);
                currentUser = username;
                isAdmin = adminStatus;
                isModerator = user.isModerator || false;
                saveUserSession(username, adminStatus);
                restoreUI();
                listenToMessages();
                alert('¬°Bienvenido!');
                closeModal('loginModal');
            } else {
                alert('Usuario o contrase√±a incorrectos');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const username = document.getElementById('registerUser').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const securityQuestion = document.getElementById('registerSecurityQuestion').value;
            const securityAnswer = document.getElementById('registerSecurityAnswer').value.toLowerCase().trim();

            if (localData.registeredUsers.find(u => u.username === username)) {
                alert('Usuario ya existe');
                return;
            }

            if (!securityQuestion) {
                alert('Selecciona una pregunta de seguridad');
                return;
            }

            if (!securityAnswer) {
                alert('Ingresa una respuesta de seguridad');
                return;
            }

            localData.registeredUsers.push({ 
                username, 
                password, 
                name, 
                email, 
                isModerator: false, 
                profilePicture: null,
                securityQuestion,
                securityAnswer
            });
            saveLocalData();
            saveToFirebase();
            alert('¬°Cuenta creada!');
            document.getElementById('registerForm').reset();
            closeModal('registerModal');
        });

        function showForgotPassword() {
            closeModal('loginModal');
            document.getElementById('forgotPasswordModal').classList.add('active');
        }

        document.getElementById('forgotPasswordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('forgotUser').value;
            const user = localData.registeredUsers.find(u => u.username === username);

            if (!user) {
                alert('Usuario no encontrado');
                return;
            }

            if (!user.securityQuestion || !user.securityAnswer) {
                alert('Este usuario no tiene pregunta de seguridad configurada');
                return;
            }

            recoveryUser = user;
            document.getElementById('securityQuestionLabel').textContent = user.securityQuestion;
            closeModal('forgotPasswordModal');
            document.getElementById('securityQuestionModal').classList.add('active');
            document.getElementById('forgotPasswordForm').reset();
        });

        document.getElementById('securityQuestionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const answer = document.getElementById('securityAnswer').value.toLowerCase().trim();

            if (!recoveryUser) {
                alert('Error en el proceso de recuperaci√≥n');
                closeModal('securityQuestionModal');
                return;
            }

            if (answer !== recoveryUser.securityAnswer) {
                alert('Respuesta incorrecta');
                return;
            }

            closeModal('securityQuestionModal');
            document.getElementById('resetPasswordModal').classList.add('active');
            document.getElementById('securityQuestionForm').reset();
        });

        document.getElementById('resetPasswordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('Las contrase√±as no coinciden');
                return;
            }

            if (!recoveryUser) {
                alert('Error en el proceso de recuperaci√≥n');
                closeModal('resetPasswordModal');
                return;
            }

            const userIndex = localData.registeredUsers.findIndex(u => u.username === recoveryUser.username);
            if (userIndex !== -1) {
                localData.registeredUsers[userIndex].password = newPassword;
                saveLocalData();
                saveToFirebase();
                alert('¬°Contrase√±a cambiada exitosamente!');
                closeModal('resetPasswordModal');
                document.getElementById('resetPasswordForm').reset();
                recoveryUser = null;
                showLogin();
            }
        });

        function logout() {
            currentUser = null;
            isAdmin = false;
            isModerator = false;
            localStorage.removeItem('userSession');
            document.getElementById('guest-buttons').classList.remove('hidden');
            document.getElementById('user-logged').classList.add('hidden');
            document.getElementById('adminBadge').classList.add('hidden');
            
            const adminLink = document.getElementById('adminLink');
            if (adminLink) adminLink.remove();
            
            const moderatorsLink = document.getElementById('moderatorsLink');
            if (moderatorsLink) moderatorsLink.remove();
            
            if (isListOpen) toggleChatList();
            if (currentChatRecipient) closePrivateChat();
            
            showSection('home');
            renderGallery();
        }

        function makeModerator(username) {
            if (!isAdmin) {
                alert('Solo el admin puede hacer moderadores');
                return;
            }

            const user = localData.registeredUsers.find(u => u.username === username);
            if (!user) return;

            user.isModerator = true;
            saveLocalData();
            saveToFirebase();
            alert('¬°' + username + ' ahora es moderador!');
            renderModeratorsPanel();
        }

        function removeModerator(username) {
            if (!isAdmin) {
                alert('Solo el admin puede remover moderadores');
                return;
            }

            const user = localData.registeredUsers.find(u => u.username === username);
            if (!user) return;

            user.isModerator = false;
            saveLocalData();
            saveToFirebase();
            alert('¬°' + username + ' ya no es moderador!');
            renderModeratorsPanel();
        }

        function renderModeratorsPanel() {
            const moderatorsList = document.getElementById('moderatorsList');
            const usersToPromoteList = document.getElementById('usersToPromoteList');
            
            if (!moderatorsList || !usersToPromoteList) return;

            const moderators = localData.registeredUsers.filter(u => u.isModerator);

            if (moderators.length === 0) {
                moderatorsList.innerHTML = '<p style="color: #999;">No hay moderadores registrados</p>';
            } else {
                moderatorsList.innerHTML = '';
                moderators.forEach(mod => {
                    const div = document.createElement('div');
                    div.className = 'mod-user-card';
                    div.innerHTML = `
                        <div>
                            <strong>${mod.name}</strong> <br>
                            <small style="color: #666;">@${mod.username}</small>
                        </div>
                        <button class="btn btn-danger" onclick="removeModerator('${mod.username}')">Remover</button>
                    `;
                    moderatorsList.appendChild(div);
                });
            }

            const nonModerators = localData.registeredUsers.filter(u => !u.isModerator && u.username !== ADMIN_USER);

            if (nonModerators.length === 0) {
                usersToPromoteList.innerHTML = '<p style="color: #999;">Todos los usuarios son moderadores</p>';
            } else {
                usersToPromoteList.innerHTML = '';
                nonModerators.forEach(user => {
                    const div = document.createElement('div');
                    div.className = 'mod-user-card promote';
                    div.innerHTML = `
                        <div>
                            <strong>${user.name}</strong> <br>
                            <small style="color: #666;">@${user.username}</small>
                        </div>
                        <button class="btn btn-primary" onclick="makeModerator('${user.username}')">Hacer MOD</button>
                    `;
                    usersToPromoteList.appendChild(div);
                });
            }
        }

        function toggleNewCategory() {
            const select = document.getElementById('categorySelect');
            const newInput = document.getElementById('newCategoryInput');
            newInput.classList.toggle('active', select.value === 'nueva');
        }

        function updateCategorySelect() {
            const select = document.getElementById('categorySelect');
            select.innerHTML = '<option value="">Seleccionar...</option>';
            localData.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
            select.innerHTML += '<option value="nueva">‚ûï Nueva categor√≠a</option>';
        }

        function updateCategoryFilter() {
            const filter = document.getElementById('categoryFilter');
            filter.innerHTML = '<button class="category-btn active" onclick="filterByCategory(\'all\')">üìÇ Todas</button>';
            localData.categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.textContent = cat;
                btn.onclick = () => filterByCategory(cat);
                filter.appendChild(btn);
            });
        }

        function filterByCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderGallery();
        }

        function updateUploadForm() {
            const type = document.getElementById('contentType').value;
            const fileArea = document.getElementById('fileInputArea');
            fileArea.style.display = (type === 'info') ? 'none' : 'block';
        }

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAdmin && !isModerator) {
                alert('Solo admin y moderadores pueden publicar');
                return;
            }

            const title = document.getElementById('contentTitle').value;
            const description = document.getElementById('contentDescription').value;
            const type = document.getElementById('contentType').value;
            const file = document.getElementById('contentFile').files[0];
            const categorySelect = document.getElementById('categorySelect').value;
            const newCategoryName = document.getElementById('newCategoryName').value.trim();

            let category = '';
            if (categorySelect === 'nueva') {
                if (!newCategoryName) {
                    alert('Ingresa nombre de categor√≠a');
                    return;
                }
                category = newCategoryName;
                if (!localData.categories.includes(category)) {
                    localData.categories.push(category);
                }
            } else if (categorySelect) {
                category = categorySelect;
            } else {
                alert('Selecciona categor√≠a');
                return;
            }

            const processContent = (contentUrl) => {
                const newContent = {
                    id: Date.now(),
                    title, description, type,
                    url: contentUrl,
                    category,
                    user: currentUser,
                    date: new Date().toLocaleDateString(),
                    comments: []
                };
                localData.contentItems.unshift(newContent);
                saveLocalData();
                saveToFirebase();
                updateCategorySelect();
                updateCategoryFilter();
                renderGallery();
                updateStats();
                alert('¬°Publicado!');
                document.getElementById('uploadForm').reset();
                document.getElementById('newCategoryInput').classList.remove('active');
                showSection('gallery');
            };

            if (type === 'info') {
                processContent(null);
            } else if (file) {
                // L√≠mite aumentado: 50MB para Cloudinary (plan gratuito permite hasta 10MB sin configurar, 50MB con cuenta)
                const maxSize = 50 * 1024 * 1024;
                if (file.size > maxSize) {
                    alert('El archivo es muy grande. M√°ximo 50MB');
                    return;
                }
                
                // Subir a Cloudinary
                uploadToCloudinary(file, type, processContent);
            } else {
                alert('Selecciona un archivo');
            }
        });

        async function uploadToCloudinary(file, type, callback) {
            // Mostrar progreso
            const progressMsg = document.createElement('div');
            progressMsg.id = 'uploadProgressMsg';
            progressMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #667eea; color: white; padding: 15px 25px; border-radius: 10px; z-index: 10000; box-shadow: 0 5px 20px rgba(0,0,0,0.3);';
            progressMsg.innerHTML = '<strong>üì§ Subiendo archivo...</strong><br><span id="uploadProgress">Preparando...</span>';
            document.body.appendChild(progressMsg);

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                
                // Agregar contexto
                formData.append('tags', `portal,${type},${currentUser}`);

                const resourceType = type === 'video' ? 'video' : 'image';
                const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;

                console.log('Subiendo a:', url);
                console.log('Upload Preset:', CLOUDINARY_UPLOAD_PRESET);
                console.log('Tipo de archivo:', file.type);
                console.log('Tama√±o:', (file.size / 1024 / 1024).toFixed(2) + ' MB');

                // Usar XMLHttpRequest para tener progreso
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        const progressEl = document.getElementById('uploadProgress');
                        if (progressEl) {
                            progressEl.textContent = percentComplete + '% completado';
                        }
                    }
                });

                xhr.addEventListener('load', () => {
                    const msg = document.getElementById('uploadProgressMsg');
                    
                    if (xhr.status === 200) {
                        if (msg) document.body.removeChild(msg);
                        const response = JSON.parse(xhr.responseText);
                        console.log('Subida exitosa:', response);
                        callback(response.secure_url);
                    } else {
                        console.error('Error en la respuesta:', xhr.status, xhr.responseText);
                        
                        // Intentar parsear el error
                        let errorMsg = 'Error al subir el archivo.';
                        try {
                            const errorData = JSON.parse(xhr.responseText);
                            errorMsg = errorData.error?.message || errorMsg;
                            console.error('Detalles del error:', errorData);
                        } catch (e) {
                            console.error('Respuesta del servidor:', xhr.responseText);
                        }
                        
                        if (msg) document.body.removeChild(msg);
                        
                        // Si falla, ofrecer usar Base64 como alternativa
                        if (file.size <= 10 * 1024 * 1024) {
                            if (confirm('Error con Cloudinary: ' + errorMsg + '\n\n¬øIntentar subir con m√©todo alternativo (Base64)?\n\nNota: Esto puede ser m√°s lento para archivos grandes.')) {
                                uploadWithBase64Fallback(file, callback);
                            } else {
                                alert('Subida cancelada. Error: ' + errorMsg);
                            }
                        } else {
                            alert('Error: ' + errorMsg + '\n\nEl archivo es muy grande para el m√©todo alternativo (m√°x 10MB).');
                        }
                    }
                });

                xhr.addEventListener('error', () => {
                    const msg = document.getElementById('uploadProgressMsg');
                    if (msg) document.body.removeChild(msg);
                    console.error('Error de red al intentar subir');
                    
                    // Ofrecer fallback
                    if (file.size <= 10 * 1024 * 1024) {
                        if (confirm('Error de conexi√≥n con Cloudinary.\n\n¬øIntentar con m√©todo alternativo (Base64)?')) {
                            uploadWithBase64Fallback(file, callback);
                        } else {
                            alert('Subida cancelada.');
                        }
                    } else {
                        alert('Error de conexi√≥n. El archivo es muy grande para el m√©todo alternativo.');
                    }
                });

                xhr.open('POST', url, true);
                xhr.send(formData);

            } catch (error) {
                console.error('Error al subir a Cloudinary:', error);
                const msg = document.getElementById('uploadProgressMsg');
                if (msg) document.body.removeChild(msg);
                
                // Ofrecer fallback
                if (file.size <= 10 * 1024 * 1024) {
                    if (confirm('Error inesperado: ' + error.message + '\n\n¬øIntentar con m√©todo alternativo?')) {
                        uploadWithBase64Fallback(file, callback);
                    } else {
                        alert('Subida cancelada.');
                    }
                } else {
                    alert('Error al subir el archivo: ' + error.message);
                }
            }
        }

        function uploadWithBase64Fallback(file, callback) {
            // Mostrar indicador
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'loadingMsg';
            loadingMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ff9800; color: white; padding: 15px 25px; border-radius: 10px; z-index: 10000; box-shadow: 0 5px 20px rgba(0,0,0,0.3);';
            loadingMsg.innerHTML = '<strong>üì¶ M√©todo alternativo...</strong><br><small>Procesando archivo localmente</small>';
            document.body.appendChild(loadingMsg);
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const msg = document.getElementById('loadingMsg');
                if (msg) document.body.removeChild(msg);
                callback(event.target.result);
            };
            reader.onerror = (error) => {
                console.error('Error al leer archivo:', error);
                const msg = document.getElementById('loadingMsg');
                if (msg) document.body.removeChild(msg);
                alert('Error al procesar el archivo.');
            };
            reader.readAsDataURL(file);
        }

        function uploadWithBase64(file, callback) {
            const reader = new FileReader();
            reader.onload = (event) => {
                callback(event.target.result);
            };
            reader.onerror = (error) => {
                console.error('Error al leer archivo:', error);
                const msg = document.getElementById('loadingMsg');
                if (msg) document.body.removeChild(msg);
                alert('Error al procesar el archivo. Intenta con un archivo m√°s peque√±o.');
            };
            reader.readAsDataURL(file);
        }

        function deletePost(postId) {
            if (!isAdmin) return;
            if (confirm('¬øEliminar publicaci√≥n?')) {
                localData.contentItems = localData.contentItems.filter(item => item.id !== postId);
                saveLocalData();
                saveToFirebase();
                renderGallery();
                updateStats();
            }
        }

        function addComment(postId) {
            if (!currentUser) {
                alert('Inicia sesi√≥n para comentar');
                showLogin();
                return;
            }

            const input = document.getElementById('comment-input-' + postId);
            const text = input.value.trim();

            if (!text) return;

            const post = localData.contentItems.find(item => item.id === postId);
            if (post) {
                if (!post.comments) post.comments = [];
                post.comments.push({
                    id: Date.now(),
                    user: currentUser,
                    text,
                    date: new Date().toLocaleString()
                });
                
                input.value = '';
                saveLocalData();
                saveToFirebase();
                renderGallery();
                updateStats();
            }
        }

        function deleteComment(postId, commentId) {
            if (!isAdmin) return;
            if (confirm('¬øEliminar comentario?')) {
                const post = localData.contentItems.find(item => item.id === postId);
                if (post) {
                    post.comments = post.comments.filter(c => c.id !== commentId);
                    saveLocalData();
                    saveToFirebase();
                    renderGallery();
                    updateStats();
                }
            }
        }

        function shareContent(postId, platform) {
            const post = localData.contentItems.find(item => item.id === postId);
            if (!post) return;

            const shareUrl = window.location.href.split('#')[0] + '#post-' + postId;
            const shareText = post.title + ' - ' + post.description;

            switch(platform) {
                case 'whatsapp':
                    window.open('https://wa.me/?text=' + encodeURIComponent(shareText + ' ' + shareUrl), '_blank');
                    break;
                case 'facebook':
                    window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(shareUrl), '_blank');
                    break;
                case 'twitter':
                    window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(shareText) + '&url=' + encodeURIComponent(shareUrl), '_blank');
                    break;
                case 'copy':
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        const btn = document.getElementById('copy-btn-' + postId);
                        if (btn) {
                            btn.innerHTML = '‚úì ¬°Copiado!';
                            btn.classList.add('copied');
                            setTimeout(() => {
                                btn.innerHTML = 'üìã Copiar';
                                btn.classList.remove('copied');
                            }, 2000);
                        }
                    });
                    break;
            }
        }

        function renderGallery() {
            const grid = document.getElementById('contentGrid');
            grid.innerHTML = '';

            let itemsToShow = currentCategory === 'all' ? 
                localData.contentItems : 
                localData.contentItems.filter(item => item.category === currentCategory);

            if (itemsToShow.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">No hay contenido</p>';
                return;
            }

            itemsToShow.forEach(item => {
                const card = document.createElement('div');
                card.className = 'content-card';
                card.id = 'post-' + item.id;

                let mediaHTML = '';
                if (item.type === 'image') {
                    mediaHTML = '<img src="' + item.url + '" alt="' + item.title + '" onclick="openFullscreenImage(\'' + item.url + '\')" style="cursor: zoom-in;">';
                } else if (item.type === 'video') {
                    mediaHTML = '<video src="' + item.url + '" controls></video>';
                } else {
                    mediaHTML = '<div style="height: 200px; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">üìÑ</div>';
                }

                let deleteBtn = isAdmin ? '<button class="btn btn-danger delete-post-btn" onclick="deletePost(' + item.id + ')">üóëÔ∏è</button>' : '';
                const categoryBadge = '<div class="category-badge">' + item.category + '</div>';

                let commentsHTML = '<div class="comments-section">';
                commentsHTML += '<strong style="color: #667eea;">üí¨ Comentarios (' + (item.comments?.length || 0) + ')</strong>';

                if (item.comments && item.comments.length > 0) {
                    item.comments.forEach(comment => {
                        let deleteCommentBtn = isAdmin ? '<button class="btn btn-danger btn-small" onclick="deleteComment(' + item.id + ',' + comment.id + ')">üóëÔ∏è</button>' : '';
                        commentsHTML += '<div class="comment">';
                        commentsHTML += '<div class="comment-header">';
                        commentsHTML += '<span class="comment-author" onclick="showUserProfile(\'' + comment.user + '\')">' + comment.user + '</span>';
                        commentsHTML += deleteCommentBtn;
                        commentsHTML += '</div>';
                        commentsHTML += '<p class="comment-text">' + comment.text + '</p>';
                        commentsHTML += '</div>';
                    });
                }

                if (currentUser) {
                    commentsHTML += '<div class="comment-form">';
                    commentsHTML += '<input type="text" class="comment-input" id="comment-input-' + item.id + '" placeholder="Comentar...">';
                    commentsHTML += '<button class="btn btn-primary btn-small" onclick="addComment(' + item.id + ')">üí¨</button>';
                    commentsHTML += '</div>';
                } else {
                    commentsHTML += '<p style="font-size: 12px; color: #999; margin-top: 10px;">Inicia sesi√≥n para comentar</p>';
                }

                commentsHTML += '</div>';

                const shareButtons = '<div class="share-buttons">' +
                    '<button class="btn-share btn-whatsapp" onclick="shareContent(' + item.id + ', \'whatsapp\')"> WhatsApp</button>' +
                    '<button class="btn-share btn-facebook" onclick="shareContent(' + item.id + ', \'facebook\')"> Facebook</button>' +
                    '<button class="btn-share btn-twitter" onclick="shareContent(' + item.id + ', \'twitter\')"> Twitter</button>' +
                    '<button class="btn-share btn-copy" id="copy-btn-' + item.id + '" onclick="shareContent(' + item.id + ', \'copy\')">üìã Copiar</button>' +
                    '</div>';

                card.innerHTML = categoryBadge + deleteBtn + mediaHTML + 
                    '<div class="content-card-body"><h3>' + item.title + '</h3><p>' + item.description + '</p>' +
                    '<p style="margin-top: 10px; font-size: 12px; color: #999;">Por: ' + item.user + ' | ' + item.date + '</p>' +
                    shareButtons + commentsHTML + '</div>';

                grid.appendChild(card);
            });
        }

        function openFullscreenImage(imageUrl) {
            const overlay = document.getElementById('imageFullscreenOverlay');
            const img = document.getElementById('fullscreenImage');
            img.src = imageUrl;
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFullscreenImage() {
            const overlay = document.getElementById('imageFullscreenOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function showUserProfile(username) {
            if (!currentUser) {
                alert('Inicia sesi√≥n para ver perfiles');
                showLogin();
                return;
            }

            if (username === currentUser) {
                alert('No puedes ver tu propio perfil');
                return;
            }

            selectedUserProfile = username;
            const user = localData.registeredUsers.find(u => u.username === username);

            if (!user) {
                alert('Usuario no encontrado');
                return;
            }

            let profileModal = document.getElementById('userProfileModal');
            if (!profileModal) {
                profileModal = document.createElement('div');
                profileModal.id = 'userProfileModal';
                profileModal.className = 'user-profile-modal';
                profileModal.innerHTML = `
                    <div class="user-profile-content">
                        <div class="user-profile-header">
                            <button class="user-profile-close" onclick="closeUserProfile()">√ó</button>
                            <div class="user-profile-avatar" id="profileAvatar">U</div>
                            <div class="user-profile-name" id="profileName">Usuario</div>
                            <div class="user-profile-username" id="profileUsername">@usuario</div>
                        </div>
                        <div class="user-profile-body">
                            <div class="user-profile-actions">
                                <button class="profile-btn profile-btn-message" onclick="startPrivateChat()">üí¨ Enviar mensaje</button>
                                <button class="profile-btn profile-btn-block" id="blockButton" onclick="toggleBlock()">üö´ Bloquear</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(profileModal);
            }

            document.getElementById('profileName').textContent = user.name || username;
            document.getElementById('profileUsername').textContent = '@' + username;
            
            const avatarEl = document.getElementById('profileAvatar');
            if (user.profilePicture) {
                avatarEl.innerHTML = '<img src="' + user.profilePicture + '" alt="' + username + '">';
            } else {
                avatarEl.innerHTML = '';
                avatarEl.textContent = username.charAt(0).toUpperCase();
            }

            let blockBtn = document.getElementById('blockButton');
            if (blockedUsers.includes(username)) {
                blockBtn.textContent = '‚úÖ Desbloquear';
                blockBtn.className = 'profile-btn profile-btn-unblock';
            } else {
                blockBtn.textContent = 'üö´ Bloquear';
                blockBtn.className = 'profile-btn profile-btn-block';
            }

            const userProfileActions = document.querySelector('.user-profile-actions');
            if (userProfileActions) {
                let moderatorBtn = userProfileActions.querySelector('[data-mod-btn="true"]');
                
                if (isAdmin && username !== ADMIN_USER) {
                    if (!moderatorBtn) {
                        moderatorBtn = document.createElement('button');
                        moderatorBtn.setAttribute('data-mod-btn', 'true');
                        moderatorBtn.className = 'profile-btn';
                        userProfileActions.appendChild(moderatorBtn);
                    }
                    
                    if (user.isModerator) {
                        moderatorBtn.textContent = ' Remover Moderador';
                        moderatorBtn.style.background = '#ff9800';
                        moderatorBtn.style.color = 'white';
                        moderatorBtn.onclick = () => {
                            removeModerator(username);
                            closeUserProfile();
                        };
                    } else {
                        moderatorBtn.textContent = 'üõ°Ô∏è Hacer Moderador';
                        moderatorBtn.style.background = '#2196F3';
                        moderatorBtn.style.color = 'white';
                        moderatorBtn.onclick = () => {
                            makeModerator(username);
                            closeUserProfile();
                        };
                    }
                } else if (moderatorBtn) {
                    moderatorBtn.remove();
                }
            }

            profileModal.classList.add('active');
        }

        function closeUserProfile() {
            const modal = document.getElementById('userProfileModal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
            selectedUserProfile = null;
        }

        function toggleBlock() {
            if (!selectedUserProfile) return;

            if (blockedUsers.includes(selectedUserProfile)) {
                blockedUsers = blockedUsers.filter(u => u !== selectedUserProfile);
                alert('Usuario desbloqueado');
            } else {
                blockedUsers.push(selectedUserProfile);
                alert('Usuario bloqueado');
                if (currentChatRecipient === selectedUserProfile) {
                    closePrivateChat();
                }
            }
            closeUserProfile();
        }

        function startPrivateChat() {
            if (!selectedUserProfile) return;

            if (!isStaff(selectedUserProfile)) {
                alert('Solo puedes chatear con administradores y moderadores');
                return;
            }

            if (blockedUsers.includes(selectedUserProfile)) {
                alert('Desbloquea primero a este usuario');
                return;
            }

            closeUserProfile();
            
            if (!isListOpen) {
                toggleChatList();
            }
            
            setTimeout(() => openPrivateChat(selectedUserProfile), 100);
        }

        function toggleChatList() {
            if (!currentUser) {
                alert('Inicia sesi√≥n para chatear');
                showLogin();
                return;
            }

            isListOpen = !isListOpen;
            const chatListWindow = document.getElementById('chatListWindow');

            if (isListOpen) {
                chatListWindow.classList.add('active');
                updateConversationsList();
            } else {
                chatListWindow.classList.remove('active');
            }
        }

        function updateConversationsList() {
            const container = document.getElementById('conversationsList');

            const allUsers = localData.registeredUsers.filter(u =>
                u.username !== currentUser &&
                !blockedUsers.includes(u.username) &&
                isStaff(u.username)
            );

            if (allUsers.length === 0) {
                container.innerHTML = '<div class="empty-chat"><div class="empty-chat-icon">üí¨</div><p>No hay administradores disponibles</p></div>';
                return;
            }

            container.innerHTML = '';

            allUsers.forEach(user => {
                const convItem = document.createElement('div');
                convItem.className = 'conversation-item';
                if (currentChatRecipient === user.username) {
                    convItem.classList.add('active');
                }

                const avatar = document.createElement('div');
                avatar.className = 'conversation-avatar';
                if (user.profilePicture) {
                    avatar.innerHTML = '<img src="' + user.profilePicture + '" alt="' + user.username + '">';
                } else {
                    avatar.textContent = user.username.charAt(0).toUpperCase();
                }

                const info = document.createElement('div');
                info.className = 'conversation-info';

                const name = document.createElement('div');
                name.className = 'conversation-name';
                name.textContent = user.name + ' (Staff)';

                const preview = document.createElement('div');
                preview.className = 'conversation-preview';
                preview.textContent = 'Iniciar conversaci√≥n';

                info.appendChild(name);
                info.appendChild(preview);

                convItem.appendChild(avatar);
                convItem.appendChild(info);

                convItem.onclick = () => openPrivateChat(user.username);

                container.appendChild(convItem);
            });
        }

        function getConversationId(user1, user2) {
            return [user1, user2].sort().join('_');
        }

        function openPrivateChat(recipientUsername) {
            if (!isStaff(recipientUsername)) {
                alert('Solo puedes chatear con staff');
                return;
            }

            if (blockedUsers.includes(recipientUsername)) {
                alert('Has bloqueado a este usuario');
                return;
            }

            currentChatRecipient = recipientUsername;
            const recipient = localData.registeredUsers.find(u => u.username === recipientUsername);

            if (!recipient) {
                alert('Usuario no encontrado');
                return;
            }

            document.getElementById('chatRecipientName').textContent = recipient.name;
            document.getElementById('chatWindow').classList.add('active');

            renderPrivateMessages();

            setTimeout(() => {
                document.getElementById('chatInput').focus();
                scrollChatToBottom();
            }, 100);
        }

        function closePrivateChat() {
            document.getElementById('chatWindow').classList.remove('active');
            currentChatRecipient = null;
        }

        function backToConversations() {
            closePrivateChat();
            if (!isListOpen) {
                toggleChatList();
            }
        }

        function listenToMessages() {
            if (!firebaseInitialized || !database || !currentUser) return;

            database.ref('privateMessages').on('value', (snapshot) => {
                const allMessages = snapshot.val();
                if (!allMessages) return;

                conversations = {};
                let totalUnread = 0;

                Object.keys(allMessages).forEach(convId => {
                    const [user1, user2] = convId.split('_');

                    if (user1 !== currentUser && user2 !== currentUser) return;

                    const otherUser = user1 === currentUser ? user2 : user1;

                    if (blockedUsers.includes(otherUser)) return;

                    if (!isStaff(otherUser) && !isStaff(currentUser)) return;

                    const messages = Object.values(allMessages[convId]).sort((a, b) => a.timestamp - b.timestamp);

                    const unreadCount = messages.filter(msg =>
                        msg.to === currentUser &&
                        !msg.read &&
                        msg.from !== currentUser
                    ).length;

                    const lastMsg = messages[messages.length - 1];

                    conversations[convId] = {
                        messages: messages,
                        unread: unreadCount,
                        lastMessage: {
                            preview: lastMsg.text.substring(0, 40),
                            timestamp: lastMsg.timestamp
                        }
                    };

                    totalUnread += unreadCount;
                });

                unreadMessages = totalUnread;
                updateChatNotification();

                if (currentChatRecipient) {
                    renderPrivateMessages();
                }

                if (isListOpen) {
                    updateConversationsList();
                }
            });
        }

        function renderPrivateMessages() {
            if (!currentChatRecipient) return;

            const container = document.getElementById('chatMessages');
            const convId = getConversationId(currentUser, currentChatRecipient);
            const conversation = conversations[convId];

            if (!conversation || conversation.messages.length === 0) {
                container.innerHTML = '<div class="empty-chat"><div class="empty-chat-icon">üí¨</div><p>No hay mensajes</p></div>';
                return;
            }

            container.innerHTML = '';

            conversation.messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message' + (msg.from === currentUser ? ' own' : '');

                const authorDiv = document.createElement('div');
                authorDiv.className = 'message-author';
                authorDiv.textContent = msg.from === currentUser ? 'T√∫' : msg.from;

                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message-bubble';
                bubbleDiv.textContent = msg.text;

                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date(msg.timestamp).toLocaleTimeString();

                messageDiv.appendChild(authorDiv);
                messageDiv.appendChild(bubbleDiv);
                messageDiv.appendChild(timeDiv);

                container.appendChild(messageDiv);
            });

            scrollChatToBottom();
        }

        function sendPrivateMessage() {
            if (!currentUser || !currentChatRecipient) return;

            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            if (!isStaff(currentChatRecipient)) {
                alert('Solo puedes enviar mensajes a staff');
                return;
            }

            const convId = getConversationId(currentUser, currentChatRecipient);

            const newMessage = {
                from: currentUser,
                to: currentChatRecipient,
                text: message,
                timestamp: Date.now(),
                read: false
            };

            if (firebaseInitialized && database) {
                database.ref('privateMessages/' + convId).push(newMessage)
                    .then(() => {
                        input.value = '';
                        scrollChatToBottom();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al enviar');
                    });
            }
        }

        function scrollChatToBottom() {
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        }

        function updateChatNotification() {
            const badge = document.getElementById('chatNotification');
            if (unreadMessages > 0) {
                badge.textContent = unreadMessages > 99 ? '99+' : unreadMessages;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        loadLocalData();

        function waitForFirebase() {
            if (typeof firebase !== 'undefined') {
                loadUserSession();
                initFirebase();
            } else {
                setTimeout(waitForFirebase, 100);
            }
        }

        waitForFirebase();

        updateCategoryFilter();
        renderGallery();
        updateStats();

        window.addEventListener('load', () => {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#post-')) {
                setTimeout(() => {
                    const element = document.querySelector(hash);
                    if (element) {
                        showSection('gallery');
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 4500);
            }
        });
    </script>
</body>
</html>


